@model CreateAdminViewModel
@{
    ViewData["Title"] = "Edit Admin Privileges";
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="fas fa-edit me-2"></i>Edit Admin Privileges</h1>
        <div>
            <a href="@Url.Action("Index")" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back to List
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="card card-modern">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-user-shield me-2"></i>
                        Editing Admin: <span class="text-warning">@Model.AdminName</span>
                    </h5>
                    <div class="small opacity-75">
                        <i class="fas fa-envelope me-1"></i>Email: @Model.Email |
                        <i class="fas fa-user-tag me-1 ms-2"></i>Type: <span class="badge bg-info">@Model.AdminType</span>
                    </div>
                </div>
                <div class="card-body">
                    <form method="post" action="@Url.Action("EditPrivileges", new { id = Model.AdminId })">
                        <input type="hidden" name="id" value="@Model.AdminId" />
                        @Html.AntiForgeryToken()

                        <!-- Template Selection -->
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label for="templateDropdown" class="form-label fw-bold">Apply Template (Optional)</label>
                                    <select id="templateDropdown" class="form-control">
                                        <option value="">-- Select Template --</option>
                                        @foreach (var template in Model.AvailableTemplates)
                                        {
                                            <option value="@template.Id">@template.TemplateName (@template.AdminType)</option>
                                        }
                                    </select>
                                    <small class="text-muted">Select a template to apply its permissions</small>
                                </div>
                            </div>
                        </div>

                        <!-- Admin Information (Read-only) -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label fw-bold">Admin Name</label>
                                    <input type="text" class="form-control" value="@Model.AdminName" readonly />
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label fw-bold">Email</label>
                                    <input type="email" class="form-control" value="@Model.Email" readonly />
                                </div>
                            </div>
                        </div>
                        <!-- Password Section - Optional for Edit -->
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <div class="alert alert-warning">
                                    <i class="fas fa-key me-2"></i>
                                    <strong>Password Update (Optional)</strong>
                                    <div class="small mt-1">
                                        Leave password fields blank to keep existing password. Only fill if you want to change the password.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label asp-for="Password" class="form-label fw-bold">New Password (Optional)</label>
                                    <div class="input-group">
                                        <input asp-for="Password" type="password" class="form-control"
                                               placeholder="Leave blank to keep current password"
                                               id="passwordField" />
                                        <button class="btn btn-outline-secondary" type="button"
                                                onclick="togglePassword('passwordField')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                    <span asp-validation-for="Password" class="text-danger"></span>
                                    <div class="password-strength mt-1">
                                        <small class="text-muted">If changing password, must be at least 6 characters with uppercase, lowercase, and number</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label asp-for="ConfirmPassword" class="form-label fw-bold">Confirm New Password (Optional)</label>
                                    <div class="input-group">
                                        <input asp-for="ConfirmPassword" type="password" class="form-control"
                                               placeholder="Confirm new password if changing"
                                               id="confirmPasswordField" />
                                        <button class="btn btn-outline-secondary" type="button"
                                                onclick="togglePassword('confirmPasswordField')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                    <span asp-validation-for="ConfirmPassword" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Admin Type and Scope (Editable) -->
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="form-group mb-3">
                                    <label asp-for="AdminType" class="form-label fw-bold"></label>
                                    <select asp-for="AdminType" asp-items="Model.AdminTypeList" class="form-control">
                                        <option value="">-- Select Admin Type --</option>
                                    </select>
                                    <span asp-validation-for="AdminType" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-group mb-3">
                                            <label asp-for="UniversityScope" class="form-label fw-bold"></label>
                                            <select asp-for="UniversityScope" asp-items="Model.UniversityList" class="form-control">
                                                <option value="">-- Select University (Optional) --</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group mb-3">
                                            <label asp-for="FacultyScope" class="form-label fw-bold"></label>
                                            <select asp-for="FacultyScope" asp-items="Model.CollegeList" class="form-control">
                                                <option value="">-- Select Faculty (Optional) --</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group mb-3">
                                            <label asp-for="DepartmentScope" class="form-label fw-bold"></label>
                                            <select asp-for="DepartmentScope" asp-items="Model.DepartmentList" class="form-control">
                                                <option value="">-- Select Department (Optional) --</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Enhanced Permissions Section -->
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label class="form-label fw-bold">Permissions</label>
                                    <div class="alert alert-info mb-3">
                                        <i class="fas fa-info-circle me-2"></i>
                                        Update the permissions for this admin. Changes will take effect immediately.
                                    </div>

                                    <!-- Permission Controls -->
                                    <div class="permission-controls mb-3">
                                        <div class="d-flex flex-wrap gap-2">
                                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllPermissions()">
                                                <i class="fas fa-check-square me-1"></i>Select All
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="deselectAllPermissions()">
                                                <i class="fas fa-times-circle me-1"></i>Deselect All
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-info" onclick="selectByCategory('UserManagement')">
                                                <i class="fas fa-users me-1"></i>All User Management
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-success" onclick="selectByCategory('Student')">
                                                <i class="fas fa-user-graduate me-1"></i>All Student Management
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-warning" onclick="selectByCategory('Course')">
                                                <i class="fas fa-book me-1"></i>All Course Management
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="selectByCategory('Grade')">
                                                <i class="fas fa-chart-bar me-1"></i>All Grade Management
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectByCategory('Finance')">
                                                <i class="fas fa-money-bill me-1"></i>All Finance Management
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="selectByCategory('University')">
                                                <i class="fas fa-university me-1"></i>All University Management
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-info" onclick="selectByCategory('College')">
                                                <i class="fas fa-building me-1"></i>All College Management
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-success" onclick="selectByCategory('Department')">
                                                <i class="fas fa-sitemap me-1"></i>All Department Management
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-warning" onclick="selectByCategory('System')">
                                                <i class="fas fa-cog me-1"></i>All System Administration
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="selectByCategory('Admin')">
                                                <i class="fas fa-user-shield me-1"></i>All Admin Management
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectByCategory('Application')">
                                                <i class="fas fa-file-alt me-1"></i>All Application Management
                                            </button>
                                        </div>
                                        <div class="mt-2">
                                            <span class="badge bg-info" id="selectedCount">@Model.CurrentPermissions.Count permissions selected</span>
                                            <span class="badge bg-secondary ms-2" id="totalCount">@Model.AllPermissions.Count total</span>
                                        </div>
                                    </div>

                                    <!-- Permission Groups -->
                                    <div class="permissions-container border rounded p-3"
                                         style="max-height: 500px; overflow-y: auto; background: rgba(var(--bs-primary-rgb), 0.03);">

                                        @{
                                            var permissionGroups = PermissionHelper.GetGroupedPermissions(Model.CurrentPermissions);
                                        }

                                        @foreach (var group in permissionGroups)
                                        {
                                            <div class="permission-group mb-4">
                                                <div class="group-header bg-light p-2 rounded mb-2 d-flex justify-content-between align-items-center">
                                                    <h6 class="mb-0 fw-bold text-primary">
                                                        <i class="fas fa-folder me-2"></i>@group.DisplayName
                                                        <small class="text-muted">(@group.Permissions.Count permissions)</small>
                                                    </h6>
                                                    <div>
                                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllInCategory('@group.GroupName')">
                                                            <i class="fas fa-check-square me-1"></i>Select All
                                                        </button>
                                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="deselectAllInCategory('@group.GroupName')">
                                                            <i class="fas fa-times-circle me-1"></i>Deselect All
                                                        </button>
                                                        <button type="button" class="btn btn-sm btn-outline-primary ms-1"
                                                                onclick="toggleGroup('@group.GroupName')">
                                                            <i class="fas fa-chevron-down"></i>
                                                        </button>
                                                    </div>
                                                </div>

                                                <div class="group-content" id="group-@group.GroupName">
                                                    <div class="row">
                                                        @foreach (var permission in group.Permissions)
                                                        {
                                                            <div class="col-md-6 col-lg-4 mb-2">
                                                                <div class="permission-item card border-0 shadow-sm">
                                                                    <div class="card-body p-2">
                                                                        <div class="form-check">
                                                                            <input class="form-check-input permission-checkbox"
                                                                                   type="checkbox"
                                                                                   name="SelectedPermissions"
                                                                                   value="@permission.Permission"
                                                                                   id="perm_@permission.Permission"
                                                                                   @(permission.IsSelected ? "checked" : "")>
                                                                            <label class="form-check-label w-100" for="perm_@permission.Permission">
                                                                                <div class="d-flex justify-content-between align-items-start">
                                                                                    <div>
                                                                                        <div class="fw-medium text-dark">@permission.DisplayName</div>
                                                                                        <div class="small text-muted">@permission.Description</div>
                                                                                    </div>
                                                                                    <div>
                                                                                        <span class="badge
                                                                                                                    @(permission.DisplayName.Contains("View") ? "bg-info" :
                                                                                                                                                                                                                                                                                                  permission.DisplayName.Contains("Create") ? "bg-success" :
                                                                                                                                                                                                                                                                                                  permission.DisplayName.Contains("Edit") ? "bg-warning" :
                                                                                                                                                                                                                                                                                                  permission.DisplayName.Contains("Delete") ? "bg-danger" :
                                                                                                                                                                                                                                                                                                  permission.DisplayName.Contains("Manage") ? "bg-primary" :
                                                                                                                                                                                                                                                                                                  permission.DisplayName.Contains("Approve") ? "bg-success" :
                                                                                                                                                                                                                                                                                                  permission.DisplayName.Contains("Reject") ? "bg-danger" :
                                                                                                                                                                                                                                                                                                  permission.DisplayName.Contains("Export") ? "bg-info" :
                                                                                                                                                                                                                                                                                                  permission.DisplayName.Contains("Import") ? "bg-warning" :
                                                                                                                                                                                                                                                                                                  permission.DisplayName.Contains("Backup") ? "bg-dark" :
                                                                                                                                                                                                                                                                                                  permission.DisplayName.Contains("Restore") ? "bg-dark" :
                                                                                                                                                                                                                                                                                                  permission.DisplayName.Contains("Logs") ? "bg-secondary" :
                                                                                                                                                                                                                                                                                                  permission.DisplayName.Contains("Settings") ? "bg-dark" : "bg-secondary")">
                                                                                    @permission.DisplayName.Split(' ').Last()
                                                                                </span>
                                                                            </div>
                                                                        </div>
                                                                    </label>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                                                                        }
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex justify-content-between">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-save me-2"></i>Update Privileges
                            </button>
                            <div>
                                <button type="button" class="btn btn-outline-warning me-2" onclick="previewChanges()">
                                    <i class="fas fa-eye me-2"></i>Preview Changes
                                </button>
                                <button type="reset" class="btn btn-outline-secondary">
                                    <i class="fas fa-redo me-2"></i>Reset
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-eye me-2"></i>Changes Preview
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="previewContent">
                    <!-- Preview will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="submitForm()">
                    <i class="fas fa-check me-2"></i>Confirm Changes
                </button>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        .permission-item:hover {
            background-color: rgba(var(--bs-primary-rgb), 0.05);
            transform: translateY(-1px);
            transition: all 0.2s ease;
        }

        .permission-item .form-check-input:checked {
            background-color: var(--bs-primary);
            border-color: var(--bs-primary);
        }

        .group-content {
            transition: max-height 0.3s ease;
        }

        .group-header {
            cursor: pointer;
        }

        .permission-controls {
            background: rgba(var(--bs-info-rgb), 0.1);
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid rgba(var(--bs-info-rgb), 0.2);
        }

        .permissions-container::-webkit-scrollbar {
            width: 8px;
        }

        .permissions-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .permissions-container::-webkit-scrollbar-thumb {
            background: var(--bs-primary);
            border-radius: 4px;
        }

            .permissions-container::-webkit-scrollbar-thumb:hover {
                background: var(--bs-primary-dark);
            }
    </style>
}

@section Scripts {
    <script>
        $(document).ready(function() {
            updateSelectedCount();

            // Update count when permissions change
            $('.permission-checkbox').change(function() {
                updateSelectedCount();
                highlightChangedPermission(this);
            });

            // Template selection handler
            $('#templateDropdown').change(function() {
                var templateId = $(this).val();
                if (templateId) {
                    // Load template permissions via AJAX
                    loadTemplatePermissions(templateId);
                } else {
                    // Clear all selections if no template selected
                    $('.permission-checkbox').prop('checked', false);
                    updateSelectedCount();
                }
            });

            // Initially expand all groups
            $('.group-content').show();

            // Update form submission to include password validation
            $('form').on('submit', function(e) {
                if (!validatePassword()) {
                    e.preventDefault();
                    return false;
                }
            });
        });

        function selectAllPermissions() {
            $('.permission-checkbox').prop('checked', true);
            updateSelectedCount();
            showToast('All permissions selected', 'success');
        }

        function deselectAllPermissions() {
            $('.permission-checkbox').prop('checked', false);
            updateSelectedCount();
            showToast('All permissions deselected', 'warning');
        }

        function selectByCategory(category) {
            $(`.permission-checkbox[value*="${category}"]`).prop('checked', true);
            updateSelectedCount();
            showToast(`All ${category} permissions selected`, 'info');
        }

        function selectAllInCategory(categoryName) {
            $(`#group-${categoryName} .permission-checkbox`).prop('checked', true);
            updateSelectedCount();
        }

        function deselectAllInCategory(categoryName) {
            $(`#group-${categoryName} .permission-checkbox`).prop('checked', false);
            updateSelectedCount();
        }

        function toggleGroup(groupName) {
            var groupContent = $('#group-' + groupName);
            var button = groupContent.closest('.permission-group').find('.group-header button i');

            if (groupContent.is(':visible')) {
                groupContent.slideUp();
                button.removeClass('fa-chevron-up').addClass('fa-chevron-down');
            } else {
                groupContent.slideDown();
                button.removeClass('fa-chevron-down').addClass('fa-chevron-up');
            }
        }

        function updateSelectedCount() {
            var selected = $('.permission-checkbox:checked').length;
            var total = $('.permission-checkbox').length;
            var currentTotal = @Model.CurrentPermissions.Count;
            $('#selectedCount').text(selected + ' permissions selected');
            $('#totalCount').text(total + ' total');
        }

        function loadTemplatePermissions(templateId) {
            $.ajax({
                url: '@Url.Action("GetTemplatePermissions", "AdminManagement")',
                type: 'GET',
                data: { templateId: templateId },
                success: function(response) {
                    if (response.success && response.permissions) {
                        // Clear all selections first
                        $('.permission-checkbox').prop('checked', false);

                        // Select permissions from template
                        response.permissions.forEach(function(permission) {
                            $(`#perm_${permission}`).prop('checked', true);
                        });

                        updateSelectedCount();
                        showToast('Template permissions loaded successfully', 'success');
                    }
                },
                error: function() {
                    showToast('Error loading template permissions', 'error');
                }
            });
        }

        function highlightChangedPermission(checkbox) {
            var $item = $(checkbox).closest('.permission-item');
            $item.addClass('changed');
            setTimeout(function() {
                $item.removeClass('changed');
            }, 1000);
        }

        function previewChanges() {
            var selectedPermissions = [];
            $('.permission-checkbox:checked').each(function() {
                selectedPermissions.push($(this).val());
            });

            var totalSelected = selectedPermissions.length;
            var currentTotal = @Model.CurrentPermissions.Count;
            var changeType = totalSelected > currentTotal ? 'Added' : 'Removed';
            var changeCount = Math.abs(totalSelected - currentTotal);

            var previewHtml = `
                <div class="alert alert-info">
                    <h6><i class="fas fa-chart-bar me-2"></i>Summary of Changes</h6>
                    <ul class="mb-0">
                        <li>Will have: <strong>${totalSelected}</strong> permissions</li>
                        <li>Currently has: <strong>${currentTotal}</strong> permissions</li>
                        <li>Change: <strong>${changeType} ${changeCount}</strong> permissions</li>
                    </ul>
                </div>

                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Permission</th>
                                <th>Category</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            // Get all permissions with their status
            $('.permission-checkbox').each(function() {
                var permission = $(this).val();
                var isChecked = $(this).is(':checked');
                var category = permission.split('_')[0];
                var status = isChecked ?
                    '<span class="badge bg-success">Selected</span>' :
                    '<span class="badge bg-secondary">Not Selected</span>';

                previewHtml += `
                    <tr>
                        <td>${permission.replace('_', ' ')}</td>
                        <td><span class="badge bg-info">${category}</span></td>
                        <td>${status}</td>
                    </tr>
                `;
            });

            previewHtml += `
                        </tbody>
                    </table>
                </div>
            `;

            $('#previewContent').html(previewHtml);
            $('#previewModal').modal('show');
        }

        function submitForm() {
            $('form').submit();
        }

        function showToast(message, type) {
            // Simple toast notification
            var toast = $(`
                <div class="toast toast-${type} position-fixed top-0 end-0 m-3" style="z-index: 1060">
                    <div class="toast-body">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                        ${message}
                        <button type="button" class="btn-close btn-close-white ms-2" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `);

            $('body').append(toast);
            setTimeout(function() {
                toast.remove();
            }, 3000);
        }

        // Modify your password validation to be optional for Edit
        function validatePassword() {
            var password = $('#passwordField').val();
            var confirmPassword = $('#confirmPasswordField').val();

            // If both are empty, that's fine (keeping current password)
            if (!password && !confirmPassword) {
                return true;
            }

            // If one is filled but not the other, show error
            if ((password && !confirmPassword) || (!password && confirmPassword)) {
                showToast('Please fill both password fields if changing password', 'error');
                return false;
            }

            // If both are filled, validate them
            if (password && confirmPassword) {
                if (password !== confirmPassword) {
                    showToast('Passwords do not match', 'error');
                    return false;
                }

                if (password.length < 6) {
                    showToast('Password must be at least 6 characters', 'error');
                    return false;
                }
            }

            return true;
        }
    </script>
}