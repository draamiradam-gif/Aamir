@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
}
@model EmailAnnouncementsViewModel
@{
    ViewData["Title"] = "Send Announcements";
}

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h3 mb-0">
                <i class="fas fa-bullhorn me-2"></i>@ViewData["Title"]
            </h1>
            <p class="text-muted">Send email announcements to users and administrators</p>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card card-modern">
                <div class="card-header">
                    <h5 class="mb-0">Compose Announcement</h5>
                </div>
                <div class="card-body">
                    @*<form asp-action="SendAnnouncement" method="post">
                    <form id="announcementForm" asp-action="SendAnnouncement" method="post">*@
                    <form id="announcementForm" asp-action="SendAnnouncement" method="post" enctype="multipart/form-data">
                        @Html.AntiForgeryToken()

                        <div class="mb-3">
                            <label asp-for="Subject" class="form-label fw-bold">Subject *</label>
                            <input asp-for="Subject" class="form-control" placeholder="Enter email subject">
                            <span asp-validation-for="Subject" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Message" class="form-label fw-bold">Message *</label>
                            <textarea asp-for="Message" class="form-control" rows="8"
                                      placeholder="Enter your announcement message..."></textarea>
                            <span asp-validation-for="Message" class="text-danger"></span>
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-bold">Recipients</label>

                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" asp-for="SendToEveryone"
                                       id="sendEveryone" value="true">
                                <label class="form-check-label" for="sendEveryone">
                                    <strong>Everyone</strong> - Send to all @Model.TotalRecipients users and admins
                                </label>
                            </div>

                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" asp-for="SendToAllAdmins"
                                       id="sendAdmins" value="true">
                                <label class="form-check-label" for="sendAdmins">
                                    <strong>All Administrators</strong> - Send to all @Model.AdminCount admins
                                </label>
                            </div>

                            <div class="form-check">
                                <input class="form-check-input" type="radio" id="sendCustom"
                                       name="selectionType" value="custom">
                                <label class="form-check-label" for="sendCustom">
                                    <strong>Custom Selection</strong>
                                </label>
                            </div>

                            <div id="customSelection" style="display: none;" class="mt-3 p-3 border rounded">
                                <div class="mb-3">
                                    <label class="form-label">Select Specific Users/Admins</label>
                                    <select class="form-select" multiple id="userSelect">
                                        <!-- Will be populated via AJAX -->
                                    </select>
                                    <small class="text-muted">Hold Ctrl to select multiple users</small>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Or Enter Custom Emails</label>
                                    <textarea class="form-control" rows="3"
                                              placeholder="Enter email addresses, one per line"></textarea>
                                    <small class="text-muted">Separate email addresses with commas or new lines</small>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between">
                            <a href="@Url.Action("Index")" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Back to Admin List
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-paper-plane me-2"></i>Send Announcement
                            </button>
                            @*<button id="testAnnouncement" class="btn btn-warning mt-3">
                                <i class="fas fa-bug me-2"></i>Test AJAX
                            </button> *@                           
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card card-modern">
                <div class="card-header">
                    <h5 class="mb-0">Recipient Statistics</h5>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span>Total Users</span>
                            <span class="badge bg-primary rounded-pill">@Model.UserCount</span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span>Total Administrators</span>
                            <span class="badge bg-success rounded-pill">@Model.AdminCount</span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span>Total Recipients</span>
                            <span class="badge bg-info rounded-pill">@Model.TotalRecipients</span>
                        </div>
                    </div>

                    <div class="mt-4">
                        <h6>Quick Actions</h6>
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-outline-primary" onclick="selectAllAdmins()">
                                <i class="fas fa-user-shield me-2"></i>Select All Admins
                            </button>
                            <a href="@Url.Action("Index", "UserManagement")" class="btn btn-outline-info">
                                <i class="fas fa-users me-2"></i>Browse All Users
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            console.log("Email announcements page loaded");

            // Handle recipient selection
            $('input[name="selectionType"]').change(function() {
                if ($(this).val() === 'custom') {
                    $('#customSelection').show();
                } else {
                    $('#customSelection').hide();
                }
            });

            // Load users for selection
            $.get('@Url.Action("GetUsersForEmail", "AdminManagement")', function(data) {
                const select = $('#userSelect');
                data.forEach(user => {
                    select.append(`<option value="${user.id}">${user.name} (${user.email})</option>`);
                });
            });

            // Form submission with AJAX
            $('#announcementForm').on('submit', function(e) {
                e.preventDefault(); // Prevent normal form submission

                console.log("Form submission started...");

                // Collect form data
                const formData = new FormData(this);

                // Collect selected users
                const selectedUsers = $('#userSelect').val() || [];
                if (selectedUsers.length > 0) {
                    formData.set('SelectedUsers', selectedUsers.join(','));
                }

                // Collect custom emails
                const customEmails = $('#customSelection textarea').val()
                    .split(/[\n,]/)
                    .map(email => email.trim())
                    .filter(email => email.length > 0);

                if (customEmails.length > 0) {
                    formData.set('CustomEmails', customEmails.join(','));
                }

                // Show loading state
                const $submitBtn = $(this).find('button[type="submit"]');
                const originalText = $submitBtn.html();
                $submitBtn.prop('disabled', true)
                    .html('<i class="fas fa-spinner fa-spin me-2"></i>Sending...');

                // Clear previous messages
                $('#successMessage, #errorMessage').remove();

                // Send AJAX request
                $.ajax({
                    url: $(this).attr('action'),
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    success: function(response) {
                        console.log("Server response:", response);

                        if (response.success) {
                            // Show success message
                            const successHtml = `
                                <div id="successMessage" class="alert alert-success alert-dismissible fade show mt-3">
                                    <i class="fas fa-check-circle me-2"></i>
                                    ${response.message}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>`;
                            $(successHtml).insertBefore('#announcementForm');

                            // Reset form after successful submission
                            $('#announcementForm')[0].reset();
                            $('#customSelection').hide();
                        } else {
                            // Show error message
                            let errorHtml = `<div id="errorMessage" class="alert alert-danger alert-dismissible fade show mt-3">
                                <i class="fas fa-exclamation-circle me-2"></i>
                                ${response.message}`;

                            if (response.errors && response.errors.length > 0) {
                                errorHtml += '<ul class="mb-0 mt-2">';
                                response.errors.forEach(error => {
                                    errorHtml += `<li>${error}</li>`;
                                });
                                errorHtml += '</ul>';
                            }

                            errorHtml += `<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
                            $(errorHtml).insertBefore('#announcementForm');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error("AJAX error:", error, xhr.responseText);

                        const errorHtml = `
                            <div id="errorMessage" class="alert alert-danger alert-dismissible fade show mt-3">
                                <i class="fas fa-exclamation-circle me-2"></i>
                                Server error occurred. Please try again.
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>`;
                        $(errorHtml).insertBefore('#announcementForm');
                    },
                    complete: function() {
                        // Restore button state
                        $submitBtn.prop('disabled', false).html(originalText);
                    }
                });
            });

            function selectAllAdmins() {
                // Check "All Administrators" radio
                $('#sendAdmins').prop('checked', true);
                $('input[name="selectionType"]').prop('checked', false);
                $('#customSelection').hide();
            }
            $.get('/AdminManagement/DebugEmailSettings', function(r) {
            console.log("🔧 Email Settings Debug:", r);
            });


            // Test 1: Debug settings
            $.get('/AdminManagement/DebugEmailSettings', function(r) {
                console.log("Settings:", r);
                alert(r.success ? "Settings loaded" : "Error: " + r.error);
            });

            // Test 2: Test with EmailService
            // Test with real service
            $.post('/AdminManagement/TestEmail', {
                    __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                }, function(r) {
                    console.log("Test with real service:", r);
                    alert(r.success ? "✅ REAL email sent! Check inbox/spam" : "❌ " + r.message);
            });

            // Test 3: Raw MailKit test
            $.post('/AdminManagement/RawMailKitTest', {
                __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
            }, function(r) {
                console.log("Raw MailKit:", r);
                alert(r.success ? "✅ Raw test sent!" : "❌ " + r.message);
            });

            $.get('/AdminManagement/CheckEmailService', function(r) {
                console.log("Service check:", r);
                alert(r.isMock ? "❌ Using MOCK service!" : "✅ Using real service");
            });


        });
    </script>
    <script>
        $('#testAnnouncement').click(function() {
            const testData = new FormData();
            testData.append('Subject', 'Test Announcement');
            testData.append('Message', 'This is a test message');
            testData.append('SendToEveryone', 'true');
            testData.append('__RequestVerificationToken', $('input[name="__RequestVerificationToken"]').val());

            $.ajax({
                url: '@Url.Action("SendAnnouncement", "AdminManagement")',
                type: 'POST',
                data: testData,
                processData: false,
                contentType: false,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                success: function(response) {
                    console.log("Test response:", response);
                    alert(response.success ? "✅ " + response.message : "❌ " + response.message);
                },
                error: function(xhr) {
                    console.log("Test error:", xhr.responseText);
                    alert("❌ AJAX Error - Check console");
                }
            });
        });
    </script>
}