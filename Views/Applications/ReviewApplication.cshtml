@model AdminApplicationViewModel
@{
    ViewData["Title"] = "Review Application";
}
@Html.AntiForgeryToken() <!-- مهم جدًا للـ POST -->

<div class="container-fluid">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-clipboard-check me-2"></i>Review Application</h5>
                </div>
                <div class="card-body">

                    <!-- Applicant Information -->
                    <h6>Applicant Information</h6>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p><strong>Name:</strong> @Model.ApplicantName</p>
                            <p><strong>Email:</strong> @Model.Email</p>
                            <p><strong>Phone:</strong> @Model.Phone</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Applied For:</strong> <span class="badge bg-info">@Model.AppliedAdminTypeName</span></p>
                            <p><strong>Applied Date:</strong> @Model.AppliedDate.ToString("MMM dd, yyyy")</p>
                            <p><strong>Status:</strong> <span class="@Model.StatusBadgeClass">@Model.Status</span></p>
                        </div>
                    </div>

                    <!-- Scope -->
                    <h6>Requested Scope</h6>
                    <div class="mb-3">
                        @if (!string.IsNullOrEmpty(Model.UniversityName))
                        {
                            <span class="badge bg-primary me-2">University: @Model.UniversityName</span>
                        }
                        @if (!string.IsNullOrEmpty(Model.FacultyName))
                        {
                            <span class="badge bg-info me-2">Faculty: @Model.FacultyName</span>
                        }
                        @if (!string.IsNullOrEmpty(Model.DepartmentName))
                        {
                            <span class="badge bg-success">Department: @Model.DepartmentName</span>
                        }
                    </div>

                    <!-- Justification -->
                    <h6>Justification</h6>
                    <div class="card bg-light mb-3">
                        <div class="card-body">
                            @Model.Justification
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="@Url.Action("Index", "Application")" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-1"></i>Back
                        </a>
                        <div>
                            <button type="button" class="btn btn-success me-2" onclick="approveApplication()">
                                <i class="fas fa-check me-1"></i>Approve
                            </button>
                            <button type="button" class="btn btn-danger" onclick="rejectApplication()">
                                <i class="fas fa-times me-1"></i>Reject
                            </button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // ==== APPROVE ====
        function approveApplication() {
            Swal.fire({
                title: 'Approve Application?',
                input: 'textarea',
                inputLabel: 'Approval Notes (optional)',
                showCancelButton: true,
                confirmButtonText: 'Approve',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if(result.isConfirmed) {
                    $.ajax({
                        url: '@Url.Action("ReviewApplication", "AdminManagement")', // Controller صح
                        type: 'POST',
                        data: {
                            id: @Model.Id,
                            status: 'Approved',
                            reviewNotes: result.value,
                            __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                        },
                        success: function(response) {
                            if(response.success) {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Application approved!',
                                    showConfirmButton: false,
                                    timer: 1500
                                }).then(() => {
                                    if(response.redirectUrl) window.location.href = response.redirectUrl;
                                });
                            } else {
                                Swal.fire('Error', response.message, 'error');
                            }
                        },
                        error: function(xhr) {
                            Swal.fire('Server Error', xhr.status + ' ' + xhr.statusText, 'error');
                        }
                    });
                }
            });
        }

        // ==== REJECT ====
        function rejectApplication() {
            Swal.fire({
                title: 'Reject Application?',
                input: 'textarea',
                inputLabel: 'Rejection Reason',
                inputPlaceholder: 'Enter reason here...',
                inputValidator: (value) => {
                    if(!value) return 'You must enter a rejection reason!';
                },
                showCancelButton: true,
                confirmButtonText: 'Reject',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if(result.isConfirmed) {
                    $.ajax({
                        url: '@Url.Action("Reject", "Applications")', // Controller
                        type: 'POST',
                        data: {
                            id: @Model.Id,
                            reviewNotes: result.value,
                            __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                        },
                        success: function(response) {
                            Swal.fire({
                                icon: response.success ? 'success' : 'error',
                                title: response.message
                            }).then(() => {
                                if(response.success && response.redirectUrl) {
                                    window.location.href = response.redirectUrl;
                                }
                            });
                        },
                        error: function(xhr) {
                            Swal.fire('Server Error', xhr.status + ' ' + xhr.statusText, 'error');
                        }
                    });
                }
            });
        }


    </script>
}
