@model List<StudentManagementSystem.Models.Course>
@{
    ViewData["Title"] = "Course Management";
    var currentFilter = ViewData["CurrentFilter"] as string;
    var currentDepartment = ViewData["CurrentDepartment"] as string;
    var currentSemester = ViewData["CurrentSemester"] as int?;
    var currentSort = ViewData["CurrentSort"] as string;
    var currentOrder = ViewData["CurrentOrder"] as string;
    var importResult = TempData["ImportResult"] as string;
    var importedCount = TempData["ImportedCount"] as int? ?? 0;
    var errorCount = TempData["ErrorCount"] as int? ?? 0;

    string GetProgressBarColor(int percentage)
    {
        if (percentage >= 90) return "bg-danger";
        if (percentage >= 70) return "bg-warning";
        return "bg-success";
    }

    int serialNumber = 1;

    // Pre-calculate values to avoid lambda expressions in HTML
    var totalCourses = Model.Count;
    
    // Calculate active courses without lambda
    int activeCoursesCount = 0;
    foreach (var course in Model)
    {
        if (course.IsActive) activeCoursesCount++;
    }

    // Get departments without lambda
    var departmentSet = new HashSet<string>();
    foreach (var course in Model)
    {
        if (!string.IsNullOrEmpty(course.Department))
            departmentSet.Add(course.Department);
    }
    var departments = new List<string>(departmentSet);
    departments.Sort();

    // Get semesters without lambda
    var semesterSet = new HashSet<int>();
    foreach (var course in Model)
    {
        semesterSet.Add(course.Semester);
    }
    var semesters = new List<int>(semesterSet);
    semesters.Sort();
}

<div class="container-fluid">
    <!-- Toast Container for notifications -->
    <div id="toastContainer" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999"></div>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>
            <i class="fas fa-book me-2"></i>Course Management
        </h2>
        <div>
            <a href="@Url.Action("Create")" class="btn btn-primary">
                <i class="fas fa-plus me-1"></i>New Course
            </a>
            <a href="@Url.Action("Import")" class="btn btn-success">
                <i class="fas fa-file-import me-1"></i>Import Excel
            </a>
            <a href="@Url.Action("Export")" class="btn btn-info">
                <i class="fas fa-file-export me-1"></i>Export Excel
            </a>
            <a class="nav-link" href="@Url.Action("Manage", "Grades")">
                <i class="fas fa-graduation-cap"></i> Grade Management
            </a>
        </div>
    </div>

    <!-- Import Results Announcement -->
    @if (!string.IsNullOrEmpty(importResult))
    {
        <div class="alert alert-info alert-dismissible fade show" role="alert">
            <h5 class="alert-heading">
                <i class="fas fa-info-circle me-2"></i>Import Completed
            </h5>
            <p class="mb-1">@importResult</p>
            @if (importedCount > 0)
            {
                <p class="mb-1">
                    <i class="fas fa-check text-success me-1"></i>
                    <strong>@importedCount</strong> courses imported successfully
                </p>
            }
            @if (errorCount > 0)
            {
                <p class="mb-0">
                    <i class="fas fa-exclamation-triangle text-warning me-1"></i>
                    <strong>@errorCount</strong> errors encountered
                </p>
            }
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Courses Summary Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card border-start border-primary border-4">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <div class="text-muted small">Total Courses</div>
                            <div class="h4 mb-0 text-primary">@totalCourses</div>
                        </div>
                        <div class="flex-shrink-0">
                            <i class="fas fa-book fa-2x text-primary"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card border-start border-success border-4">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <div class="text-muted small">Active Courses</div>
                            <div class="h4 mb-0 text-success">@activeCoursesCount</div>
                        </div>
                        <div class="flex-shrink-0">
                            <i class="fas fa-check-circle fa-2x text-success"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card border-start border-warning border-4">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <div class="text-muted small">Selected</div>
                            <div class="h4 mb-0 text-warning" id="selectedCountBadge">0</div>
                        </div>
                        <div class="flex-shrink-0">
                            <i class="fas fa-check-circle fa-2x text-warning"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card border-start border-info border-4">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <div class="text-muted small">Actions</div>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-info" id="selectAllBtn">
                                    <i class="fas fa-check-square me-1"></i>All
                                </button>
                                <button class="btn btn-outline-info" id="deselectAllBtn">
                                    <i class="fas fa-square me-1"></i>None
                                </button>
                                <button class="btn btn-outline-info" id="columnToggleBtn" data-bs-toggle="modal" data-bs-target="#columnModal">
                                    <i class="fas fa-columns me-1"></i>Columns
                                </button>
                            </div>
                        </div>
                        <div class="flex-shrink-0">
                            <i class="fas fa-cogs fa-2x text-info"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Actions Toolbar -->
    <div class="card mb-4" id="bulkActionsToolbar" style="display: none;">
        <div class="card-header bg-warning">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h5 class="mb-0 text-white">
                        <i class="fas fa-tools me-2"></i>Bulk Actions
                        <span class="badge bg-light text-dark ms-2" id="bulkSelectedCount">0</span>
                    </h5>
                </div>
                <div class="col-md-6 text-end">
                    <div class="btn-group">
                        <button type="button" class="btn btn-danger btn-sm" id="deleteSelectedBtn">
                            <i class="fas fa-trash me-1"></i>Delete Selected
                        </button>
                        <button type="button" class="btn btn-outline-danger btn-sm" id="deleteAllBtn">
                            <i class="fas fa-broom me-1"></i>Delete All
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="cancelBulkBtn">
                            <i class="fas fa-times me-1"></i>Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filters Card -->
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0">
                <i class="fas fa-filter"></i> Filters & Search
            </h5>
        </div>
        <div class="card-body">
            <form method="get" asp-action="Index" class="row g-3" id="filterForm">
                <!-- Search Input -->
                <div class="col-md-4">
                    <label for="searchString" class="form-label">Search Courses</label>
                    <div class="input-group">
                        <input type="text" 
                               name="searchString" 
                               class="form-control" 
                               placeholder="Search by code, name, description..."
                               value="@currentFilter" />
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Department Filter -->
                <div class="col-md-3">
                    <label for="department" class="form-label">Department</label>
                    <select name="department" class="form-select" id="departmentSelect">
                        <option value="">All Departments</option>
                        @foreach (var dept in departments)
                        {
                            var isSelected = currentDepartment == dept;
                            <option value="@dept" selected="@isSelected">@dept</option>
                        }
                    </select>
                </div>
                
                <!-- Semester Filter -->
                <div class="col-md-3">
                    <label for="semester" class="form-label">Semester</label>
                    <select name="semester" class="form-select" id="semesterSelect">
                        <option value="">All Semesters</option>
                        @foreach (var sem in semesters)
                        {
                            var isSelected = currentSemester?.ToString() == sem.ToString();
                            <option value="@sem" selected="@isSelected">Semester @sem</option>
                        }
                    </select>
                </div>
                
                <!-- Action Buttons -->
                <div class="col-md-2">
                    <label class="form-label">&nbsp;</label>
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary flex-fill">
                            <i class="fas fa-filter"></i> Apply
                        </button>
                        @if (!string.IsNullOrEmpty(currentFilter) || !string.IsNullOrEmpty(currentDepartment) || currentSemester.HasValue)
                        {
                            <a href="@Url.Action("Index")" class="btn btn-outline-danger">
                                <i class="fas fa-times"></i>
                            </a>
                        }
                    </div>
                </div>
                
                <!-- Hidden fields to preserve sorting -->
                <input type="hidden" name="sortBy" value="@currentSort" />
                <input type="hidden" name="sortOrder" value="@currentOrder" />
            </form>
            
            <!-- Active Filters Display -->
            @if (!string.IsNullOrEmpty(currentFilter) || !string.IsNullOrEmpty(currentDepartment) || currentSemester.HasValue)
            {
                <div class="mt-3 p-3 bg-light rounded">
                    <small class="text-muted fw-bold">Active Filters:</small>
                    <div class="d-flex flex-wrap gap-2 mt-2">
                        @if (!string.IsNullOrEmpty(currentFilter))
                        {
                            <span class="badge bg-primary">
                                <i class="fas fa-search me-1"></i> Search: "@currentFilter"
                                <a href="@Url.Action("Index", new { 
                                    department = currentDepartment, 
                                    semester = currentSemester,
                                    sortBy = currentSort,
                                    sortOrder = currentOrder
                                })" class="text-white ms-2">
                                    <i class="fas fa-times"></i>
                                </a>
                            </span>
                        }
                        @if (!string.IsNullOrEmpty(currentDepartment))
                        {
                            <span class="badge bg-info">
                                <i class="fas fa-building me-1"></i> Department: @currentDepartment
                                <a href="@Url.Action("Index", new { 
                                    searchString = currentFilter, 
                                    semester = currentSemester,
                                    sortBy = currentSort,
                                    sortOrder = currentOrder
                                })" class="text-white ms-2">
                                    <i class="fas fa-times"></i>
                                </a>
                            </span>
                        }
                        @if (currentSemester.HasValue)
                        {
                            <span class="badge bg-warning text-dark">
                                <i class="fas fa-calendar me-1"></i> Semester: @currentSemester
                                <a href="@Url.Action("Index", new { 
                                    searchString = currentFilter, 
                                    department = currentDepartment,
                                    sortBy = currentSort,
                                    sortOrder = currentOrder
                                })" class="text-dark ms-2">
                                    <i class="fas fa-times"></i>
                                </a>
                            </span>
                        }
                    </div>
                </div>
            }
        </div>
    </div>

    <!-- Courses Table Container -->
    <div class="card">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-table"></i> Courses List
                <span class="badge bg-primary ms-2">@totalCourses Total</span>
            </h5>
            <div class="btn-group">
                <form id="exportForm" asp-action="ExportSelected" method="post" class="d-inline">
                    <button type="submit" class="btn btn-outline-info btn-sm" id="exportSelectedBtn">
                        <i class="fas fa-download"></i> Export Selected
                    </button>
                </form>
                <button class="btn btn-outline-success btn-sm" id="quickEnrollBtn" style="display: none;">
                    <i class="fas fa-user-plus"></i> Quick Enroll
                </button>
            </div>
        </div>

        <!-- Scrollable Table Container -->
        <div class="table-container" style="max-height: 70vh; overflow: auto;">
            <table class="table table-striped table-hover table-bordered mb-0" id="coursesTable">
                <thead class="table-dark sticky-top">
                    <tr>
                        <th class="column-checkbox text-center" width="50">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="selectAll">
                            </div>
                        </th>
                        <th class="column-serial text-center sortable" data-sort="serial">
                            <a href="@Url.Action("Index", new { sortBy = "Serial", sortOrder = currentSort == "Serial" && currentOrder == "asc" ? "desc" : "asc", searchString = currentFilter })" class="text-white text-decoration-none">
                                #
                                @if (currentSort == "Serial")
                                {
                                    <i class="fas @(currentOrder == "asc" ? "fa-sort-up" : "fa-sort-down")"></i>
                                }
                                else
                                {
                                    <i class="fas fa-sort"></i>
                                }
                            </a>
                        </th>
                        <th class="column-code sortable" data-sort="coursecode">
                            <a href="@Url.Action("Index", new { sortBy = "CourseCode", sortOrder = currentSort == "CourseCode" && currentOrder == "asc" ? "desc" : "asc", searchString = currentFilter })" class="text-white text-decoration-none">
                                Course Code
                                @if (currentSort == "CourseCode")
                                {
                                    <i class="fas @(currentOrder == "asc" ? "fa-sort-up" : "fa-sort-down")"></i>
                                }
                                else
                                {
                                    <i class="fas fa-sort"></i>
                                }
                            </a>
                        </th>
                        <th class="column-name sortable" data-sort="coursename">
                            <a href="@Url.Action("Index", new { sortBy = "CourseName", sortOrder = currentSort == "CourseName" && currentOrder == "asc" ? "desc" : "asc", searchString = currentFilter })" class="text-white text-decoration-none">
                                Course Name
                                @if (currentSort == "CourseName")
                                {
                                    <i class="fas @(currentOrder == "asc" ? "fa-sort-up" : "fa-sort-down")"></i>
                                }
                                else
                                {
                                    <i class="fas fa-sort"></i>
                                }
                            </a>
                        </th>
                        <th class="column-description sortable">
                            <a href="@Url.Action("Index", new { sortBy = "Description", sortOrder = currentSort == "Description" && currentOrder == "asc" ? "desc" : "asc", searchString = currentFilter })" class="text-white text-decoration-none">
                                Description
                                @if (currentSort == "Description")
                                {
                                    <i class="fas @(currentOrder == "asc" ? "fa-sort-up" : "fa-sort-down")"></i>
                                }
                                else
                                {
                                    <i class="fas fa-sort"></i>
                                }
                            </a>
                        </th>
                       <th class="column-prerequisites sortable" data-sort="prerequisites">
                            <a href="@Url.Action("Index", new { sortBy = "Prerequisites", sortOrder = currentSort == "Prerequisites" && currentOrder == "asc" ? "desc" : "asc", searchString = currentFilter })" class="text-white text-decoration-none">
                                Prerequisites
                                @if (currentSort == "Prerequisites")
                                {
                                    <i class="fas @(currentOrder == "asc" ? "fa-sort-up" : "fa-sort-down")"></i>
                                }
                                else
                                {
                                    <i class="fas fa-sort"></i>
                                }
                            </a>
                        </th>
                        <th class="column-credits text-center sortable" data-sort="credits">
                            <a href="@Url.Action("Index", new { sortBy = "Credits", sortOrder = currentSort == "Credits" && currentOrder == "asc" ? "desc" : "asc", searchString = currentFilter })" class="text-white text-decoration-none">
                                Credits
                                @if (currentSort == "Credits")
                                {
                                    <i class="fas @(currentOrder == "asc" ? "fa-sort-up" : "fa-sort-down")"></i>
                                }
                                else
                                {
                                    <i class="fas fa-sort"></i>
                                }
                            </a>
                        </th>
                        <th class="column-department sortable" data-sort="department">
                            <a href="@Url.Action("Index", new { sortBy = "Department", sortOrder = currentSort == "Department" && currentOrder == "asc" ? "desc" : "asc", searchString = currentFilter })" class="text-white text-decoration-none">
                                Department
                                @if (currentSort == "Department")
                                {
                                    <i class="fas @(currentOrder == "asc" ? "fa-sort-up" : "fa-sort-down")"></i>
                                }
                                else
                                {
                                    <i class="fas fa-sort"></i>
                                }
                            </a>
                        </th>
                        <th class="column-semester text-center sortable" data-sort="semester">
                            <a href="@Url.Action("Index", new { sortBy = "Semester", sortOrder = currentSort == "Semester" && currentOrder == "asc" ? "desc" : "asc", searchString = currentFilter })" class="text-white text-decoration-none">
                                Semester
                                @if (currentSort == "Semester")
                                {
                                    <i class="fas @(currentOrder == "asc" ? "fa-sort-up" : "fa-sort-down")"></i>
                                }
                                else
                                {
                                    <i class="fas fa-sort"></i>
                                }
                            </a>
                        </th>
                        <th class="column-enrollment text-center sortable" data-sort="enrollment">
                            <a href="@Url.Action("Index", new { sortBy = "Enrollment", sortOrder = currentSort == "Enrollment" && currentOrder == "asc" ? "desc" : "asc", searchString = currentFilter })" class="text-white text-decoration-none">
                                Enrollment
                                @if (currentSort == "Enrollment")
                                {
                                    <i class="fas @(currentOrder == "asc" ? "fa-sort-up" : "fa-sort-down")"></i>
                                }
                                else
                                {
                                    <i class="fas fa-sort"></i>
                                }
                            </a>
                        </th>
                        <th class="column-status text-center sortable" data-sort="status">
                            <a href="@Url.Action("Index", new { sortBy = "Status", sortOrder = currentSort == "Status" && currentOrder == "asc" ? "desc" : "asc", searchString = currentFilter })" class="text-white text-decoration-none">
                                Status
                                @if (currentSort == "Status")
                                {
                                    <i class="fas @(currentOrder == "asc" ? "fa-sort-up" : "fa-sort-down")"></i>
                                }
                                else
                                {
                                    <i class="fas fa-sort"></i>
                                }
                            </a>
                        </th>
                        <th class="column-actions text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                @foreach (var course in Model)
                {
                    <tr>
                        <td class="column-checkbox text-center">
                            <div class="form-check">
                                <input class="form-check-input course-checkbox" type="checkbox" name="selectedCourses" value="@course.Id" data-course-name="@course.CourseName">
                            </div>
                        </td>
                        <td class="column-serial text-center">@serialNumber</td>
                        <td class="column-code fw-bold">@course.CourseCode</td>
                        <td class="column-name text-nowrap">@course.CourseName</td>
                        <td class="column-description">
                            @if (!string.IsNullOrEmpty(course.Description))
                            {
                                <div class="description-truncate">
                                    @if (course.Description.Length > 100)
                                    {
                                        <span class="truncated-text" 
                                              data-bs-toggle="tooltip" 
                                              data-bs-placement="top" 
                                              title="@course.Description">
                                            @course.Description.Substring(0, 100)...
                                        </span>
                                        <button type="button" 
                                                class="btn btn-sm btn-link p-0 ms-1 view-full-description"
                                                data-description="@course.Description">
                                            <i class="fas fa-expand-alt"></i>
                                        </button>
                                    }
                                    else
                                    {
                                        <span data-bs-toggle="tooltip" title="@course.Description">
                                            @course.Description
                                        </span>
                                    }
                                </div>
                            }
                            else
                            {
                                <span class="text-muted">No description</span>
                            }
                        </td>
                        <td class="column-prerequisites text-center">
                            @if (!string.IsNullOrEmpty(course.PrerequisitesString))
                            {
                                <div class="prerequisites-list">
                                    @{
                                        // Fix for lambda expressions in prerequisites
                                        var prereqArray = course.PrerequisitesString.Split(',');
                                        var validPrereqCodes = new List<string>();
                                        foreach (var prereq in prereqArray)
                                        {
                                            var trimmed = prereq.Trim();
                                            if (!string.IsNullOrEmpty(trimmed))
                                            {
                                                validPrereqCodes.Add(trimmed);
                                            }
                                        }
                                        var displayPrereqCodes = validPrereqCodes.Take(3).ToList();
                                    }
                                    @foreach (var prereqCode in displayPrereqCodes)
                                    {
                                        <span class="badge bg-secondary me-1 mb-1" 
                                              data-bs-toggle="tooltip" 
                                              title="@prereqCode">
                                            @prereqCode
                                        </span>
                                    }
                                    @if (validPrereqCodes.Count > 3)
                                    {
                                        <span class="badge bg-light text-dark">+@(validPrereqCodes.Count - 3) more</span>
                                    }
                                </div>
                            }
                            else
                            {
                                <span class="text-muted">None</span>
                            }
                        </td>
                        <td class="column-credits text-center">
                            <span class="badge bg-info">@course.Credits</span>
                        </td>
                        <td class="column-department">@course.Department</td>
                        <td class="column-semester text-center">
                            <span class="badge bg-secondary">@course.Semester</span>
                        </td>
                        <td class="column-enrollment text-center">
                            @{
                                var enrollmentPercentage = course.MaxStudents > 0 ?
                                (int)((course.CurrentEnrollment * 100.0) / course.MaxStudents) : 0;
                                var availableSeats = course.MaxStudents - course.CurrentEnrollment;
                            }
                            <div class="enrollment-info">
                                <div class="progress mb-1" style="height: 6px;" title="@enrollmentPercentage% Full">
                                    <div class="progress-bar @GetProgressBarColor(enrollmentPercentage)"
                                         style="width: @enrollmentPercentage%">
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between small">
                                    <span class="text-muted">@course.CurrentEnrollment/@course.MaxStudents</span>
                                    <span class="text-success">@availableSeats seats left</span>
                                </div>
                            </div>
                        </td>
                        <td class="column-status text-center">
                            @if (course.IsActive)
                            {
                                <span class="badge bg-success">
                                    <i class="fas fa-check-circle me-1"></i>Active
                                </span>
                            }
                            else
                            {
                                <span class="badge bg-secondary">
                                    <i class="fas fa-times-circle me-1"></i>Inactive
                                </span>
                            }
                        </td>
                        <td class="column-actions text-center">
                            <div class="btn-group btn-group-sm" role="group">
                                <a href="@Url.Action("Details", new { id = course.Id })" class="btn btn-info" title="View Details" data-bs-toggle="tooltip">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a href="@Url.Action("Edit", new { id = course.Id })" class="btn btn-warning" title="Edit Course" data-bs-toggle="tooltip">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <a href="@Url.Action("Enroll", new { id = course.Id })" class="btn btn-success" title="Manage Enrollment" data-bs-toggle="tooltip">
                                    <i class="fas fa-user-plus"></i>
                                </a>
                                <a href="@Url.Action("Delete", new { id = course.Id })" class="btn btn-danger delete-course" title="Delete Course" data-bs-toggle="tooltip" data-course-id="@course.Id" data-course-name="@course.CourseName">
                                    <i class="fas fa-trash"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    serialNumber++;
                }
            </tbody>
            </table>
        </div>

        <!-- Empty State -->
        @if (!Model.Any())
        {
            <div class="card-body text-center py-5">
                <i class="fas fa-book-open fa-4x text-muted mb-3"></i>
                <h4 class="text-muted">No Courses Found</h4>
                <p class="text-muted mb-4">No courses match your current filters.</p>
                <div class="d-flex justify-content-center gap-2">
                    <a href="@Url.Action("Create")" class="btn btn-primary">
                        <i class="fas fa-plus me-1"></i>Create First Course
                    </a>
                    <a href="@Url.Action("Index")" class="btn btn-outline-secondary">
                        <i class="fas fa-times me-1"></i>Clear Filters
                    </a>
                </div>
            </div>
        }
    </div>
</div>

<!-- Column Customization Modal -->
<div class="modal fade" id="columnModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-columns me-2"></i>Customize Columns
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-3">Select which columns to display in the table:</p>
                <div class="form-check mb-2">
                    <input class="form-check-input column-toggle" type="checkbox" id="toggleDescription" data-column="description" checked>
                    <label class="form-check-label" for="toggleDescription">Description</label>
                </div>
                <div class="form-check mb-2">
                    <input class="form-check-input column-toggle" type="checkbox" id="toggleDepartment" data-column="department" checked>
                    <label class="form-check-label" for="toggleDepartment">Department</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="autoSaveColumns">
                    <label class="form-check-label" for="autoSaveColumns">Remember my preferences</label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="applyColumns">Apply</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>Confirm Deletion
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="deleteSingleContent">
                    <p>Are you sure you want to delete course <strong id="deleteCourseName"></strong>?</p>
                    <p class="text-muted small">This action cannot be undone.</p>
                </div>
                <div id="deleteMultipleContent" style="display: none;">
                    <p>Are you sure you want to delete <strong id="deleteCount">0</strong> selected courses?</p>
                    <div id="deleteCourseList" class="small text-muted mt-2" style="max-height: 100px; overflow-y: auto;"></div>
                    <p class="text-danger mt-2"><i class="fas fa-exclamation-circle me-1"></i>This action cannot be undone!</p>
                </div>
                <div id="deleteAllContent" style="display: none;">
                    <div class="alert alert-warning">
                        <h6><i class="fas fa-radiation me-2"></i>Danger Zone</h6>
                        <p class="mb-0">You are about to delete <strong>ALL @totalCourses courses</strong> from the system!</p>
                    </div>
                    <p class="text-danger">
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        <strong>Warning:</strong> This action is irreversible and will permanently remove all course records.
                    </p>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="confirmDeleteAll">
                        <label class="form-check-label text-danger" for="confirmDeleteAll">
                            I understand this action cannot be undone
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-danger" id="confirmDeleteBtn" disabled>Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Full Description Modal -->
<div class="modal fade" id="descriptionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Course Description</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="fullDescriptionContent" style="white-space: pre-wrap; word-wrap: break-word;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        /* Your existing CSS styles here - they should work fine */
        .table-container {
            position: relative;
            border: 1px solid #dee2e6;
        }
        .sticky-top {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .table th {
            position: relative;
            cursor: pointer;
            white-space: nowrap;
            background-color: #343a40;
            color: white;
        }
        .table th a {
            text-decoration: none;
            color: inherit;
            display: block;
        }
        .table th:hover {
            background-color: #495057;
        }
        .sortable {
            cursor: pointer;
            user-select: none;
        }
        #coursesTable {
            table-layout: fixed;
            width: 100%;
            margin-bottom: 0;
        }
        .column-checkbox { width: 50px; min-width: 50px; max-width: 50px; }
        .column-serial { width: 70px; min-width: 70px; max-width: 70px; }
        .column-code { width: 100px; min-width: 100px; max-width: 100px; }
        .column-name { width: 200px; min-width: 200px; max-width: 200px; }
        .column-description { width: 200px; min-width: 200px; max-width: 200px; }
        .column-prerequisites { width: 150px; min-width: 150px; max-width: 150px; }
        .column-credits { width: 80px; min-width: 80px; max-width: 80px; }
        .column-department { width: 120px; min-width: 120px; max-width: 120px; }
        .column-semester { width: 100px; min-width: 100px; max-width: 100px; }
        .column-enrollment { width: 120px; min-width: 120px; max-width: 120px; }
        .column-status { width: 100px; min-width: 100px; max-width: 100px; }
        .column-actions { width: 180px; min-width: 180px; max-width: 180px; }
        #coursesTable td {
            word-wrap: break-word;
            vertical-align: middle;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .column-description {
            white-space: normal !important;
            line-height: 1.3;
            max-height: 60px;
            overflow: hidden;
        }
        #coursesTable tbody tr:hover {
            background-color: rgba(0, 123, 255, 0.1);
        }
        .form-check-input:checked {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }
        .btn-group-sm > .btn {
            padding: 0.25rem 0.5rem;
        }
        .progress {
            background-color: #e9ecef;
            border-radius: 0.375rem;
        }
        .progress-bar {
            border-radius: 0.375rem;
            transition: width 0.3s ease;
        }
        #bulkActionsToolbar {
            transition: all 0.3s ease;
        }
        .enrollment-info {
            min-width: 100px;
        }
        .table-container::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .table-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .table-container::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        .table-container::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        .column-description, .column-department {
            transition: all 0.3s ease;
        }
        @@media (max-width: 768px) {
            .table-container {
                max-height: 50vh;
            }
            .btn-group-sm > .btn {
                padding: 0.2rem 0.4rem;
            }
            #coursesTable {
                font-size: 0.875rem;
            }
            .column-code { width: 80px; min-width: 80px; }
            .column-name { width: 150px; min-width: 150px; }
            .column-description { width: 120px; min-width: 120px; }
            .column-prerequisites { width: 100px; min-width: 100px; }
        }
        .course-description {
            max-width: 300px;
            display: inline-block;
            vertical-align: middle;
        }
        .modal-body {
            word-wrap: break-word;
            white-space: pre-wrap;
            max-height: 60vh;
            overflow-y: auto;
        }
        textarea.form-control {
            resize: vertical;
            min-height: 120px;
        }
    </style>
}

@section Scripts {
<script>
// Set server-side values for JavaScript
const serverData = {
    totalCourses: @totalCourses
};

document.addEventListener('DOMContentLoaded', function () {

    // ========================
    // TOOLTIP INITIALIZATION
    // ========================
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (el) { return new bootstrap.Tooltip(el); });

    // ========================
    // ELEMENT REFERENCES
    // ========================
    const selectAll = document.getElementById('selectAll');
    const courseCheckboxes = document.querySelectorAll('.course-checkbox');
    const selectedCountBadge = document.getElementById('selectedCountBadge');
    const bulkSelectedCount = document.getElementById('bulkSelectedCount');
    const bulkActionsToolbar = document.getElementById('bulkActionsToolbar');
    const selectAllBtn = document.getElementById('selectAllBtn');
    const deselectAllBtn = document.getElementById('deselectAllBtn');
    const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
    const deleteAllBtn = document.getElementById('deleteAllBtn');
    const cancelBulkBtn = document.getElementById('cancelBulkBtn');
    const exportSelectedBtn = document.getElementById('exportSelectedBtn');
    const quickEnrollBtn = document.getElementById('quickEnrollBtn');

    const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
    const deleteCourseName = document.getElementById('deleteCourseName');
    const deleteCount = document.getElementById('deleteCount');
    const deleteCourseList = document.getElementById('deleteCourseList');
    const confirmDeleteAll = document.getElementById('confirmDeleteAll');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

    const applyColumnsBtn = document.getElementById('applyColumns');
    const columnToggles = document.querySelectorAll('.column-toggle');
    const autoSaveColumns = document.getElementById('autoSaveColumns');

    let currentDeleteAction = '';
    let currentCourseId = null;
    let selectedCourseIds = [];

    // ========================
    // COLUMN PREFERENCES
    // ========================
    function loadColumnPreferences() {
        const saved = localStorage.getItem('courseTableColumns');
        if (saved) {
            const cols = JSON.parse(saved);
            columnToggles.forEach(t => {
                const col = t.dataset.column;
                t.checked = cols[col] !== false;
                toggleColumn(col, t.checked);
            });
            autoSaveColumns.checked = true;
        }
    }

    function saveColumnPreferences() {
        if (!autoSaveColumns.checked) return;

        const cols = {};
        columnToggles.forEach(t => {
            cols[t.dataset.column] = t.checked;
        });
        localStorage.setItem('courseTableColumns', JSON.stringify(cols));
    }

    function toggleColumn(column, show) {
        document.querySelectorAll(`th.column-${column}`).forEach(h => h.style.display = show ? '' : 'none');
        document.querySelectorAll(`td.column-${column}`).forEach(c => c.style.display = show ? '' : 'none');
    }

    // ========================
    // SELECTION HANDLING
    // ========================
    function updateSelectedCount() {
        const selected = document.querySelectorAll('.course-checkbox:checked').length;
        selectedCountBadge.textContent = selected;
        bulkSelectedCount.textContent = selected;

        bulkActionsToolbar.style.display = selected > 0 ? 'block' : 'none';
        quickEnrollBtn.style.display = selected > 0 ? 'inline-block' : 'none';

        exportSelectedBtn.disabled = selected === 0;
        deleteSelectedBtn.disabled = selected === 0;

        // Update selected course IDs
        selectedCourseIds = getSelectedCourseIds();
    }

    function selectAllCourses(state) {
        courseCheckboxes.forEach(c => c.checked = state);
        selectAll.checked = state;
        updateSelectedCount();
    }

    function getSelectedCourses() {
        const list = [];
        courseCheckboxes.forEach(cb => {
            if (cb.checked) {
                list.push({
                    id: cb.value,
                    name: cb.dataset.courseName
                });
            }
        });
        return list;
    }

    function getSelectedCourseIds() {
        return getSelectedCourses().map(x => x.id);
    }

    // ========================
    // DELETE CONFIRMATION
    // ========================
    function showDeleteConfirmation(action, courseId = null, courseName = null) {
        currentDeleteAction = action;
        currentCourseId = courseId;

        deleteCourseList.innerHTML = "";
        deleteCount.textContent = "";
        deleteCourseName.textContent = "";

        document.getElementById('deleteSingleContent').style.display = 'none';
        document.getElementById('deleteMultipleContent').style.display = 'none';
        document.getElementById('deleteAllContent').style.display = 'none';

        confirmDeleteAll.checked = false;
        confirmDeleteBtn.disabled = true;

        if (action === 'single') {
            document.getElementById('deleteSingleContent').style.display = 'block';
            deleteCourseName.textContent = courseName;
            confirmDeleteBtn.disabled = false;
        } else if (action === 'multiple') {
            const selected = getSelectedCourses();
            document.getElementById('deleteMultipleContent').style.display = 'block';
            deleteCount.textContent = selected.length;

            selected.forEach(c => {
                const div = document.createElement('div');
                div.className = 'border-bottom pb-1 mb-1';
                div.textContent = c.name;
                deleteCourseList.appendChild(div);
            });

            confirmDeleteBtn.disabled = false;
        } else if (action === 'all') {
            document.getElementById('deleteAllContent').style.display = 'block';
        }

        deleteModal.show();
    }

    // ========================
    // EVENT LISTENERS
    // ========================
    selectAll.addEventListener('change', function () {
        selectAllCourses(this.checked);
    });

    courseCheckboxes.forEach(cb => {
        cb.addEventListener('change', function () {
            selectAll.checked =
                document.querySelectorAll('.course-checkbox:checked').length === courseCheckboxes.length;
            updateSelectedCount();
        });
    });

    selectAllBtn.onclick = () => selectAllCourses(true);
    deselectAllBtn.onclick = () => selectAllCourses(false);
    cancelBulkBtn.onclick = () => selectAllCourses(false);

    // Delete Selected Courses
    deleteSelectedBtn.onclick = function () {
        const selected = getSelectedCourses();
        if (selected.length === 0) {
            showToast('Please select at least one course to delete.', 'warning');
            return;
        }
        showDeleteConfirmation('multiple');
    };

    // Delete All Courses - FIXED: Using serverData
    deleteAllBtn.onclick = function () {
        const totalCourses = serverData.totalCourses || 0;
        if (totalCourses === 0) {
            showToast('No courses available to delete.', 'warning');
            return;
        }
        showDeleteConfirmation('all');
    };

    // Confirm Delete All Checkbox
    confirmDeleteAll.addEventListener('change', function () {
        confirmDeleteBtn.disabled = !this.checked;
    });

    // ========================
    // CONFIRM DELETE HANDLER
    // ========================
    confirmDeleteBtn.addEventListener('click', function () {
        if (currentDeleteAction === 'single') {
            // Redirect to individual delete confirmation page
            window.location.href = `@Url.Action("Delete", "Courses")/${currentCourseId}`;
        }
        else if (currentDeleteAction === 'multiple') {
            // Submit bulk delete via form (redirects to confirmation)
            submitBulkDelete();
        }
        else if (currentDeleteAction === 'all') {
            // Submit delete all via form (redirects to confirmation)
            submitDeleteAll();
        }
    });

    // ========================
    // SUBMIT BULK DELETE (VIA FORM REDIRECT)
    // ========================
    function submitBulkDelete() {
        const selectedIds = getSelectedCourseIds();
        if (selectedIds.length === 0) {
            showToast('No courses selected.', 'warning');
            return;
        }

        // Create a form and submit it to redirect to confirmation page (GET request)
        const form = document.createElement('form');
        form.method = 'GET';
        form.action = '@Url.Action("BulkDeleteConfirmation", "Courses")';

        // Add selected course IDs as query parameters
        selectedIds.forEach(id => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'selectedCourses';
            input.value = id;
            form.appendChild(input);
        });

        document.body.appendChild(form);
        form.submit();
    }

    // ========================
    // DELETE ALL (VIA FORM REDIRECT)
    // ========================
    function submitDeleteAll() {
        // Create a form and submit it to redirect to confirmation page (GET request)
        const form = document.createElement('form');
        form.method = 'GET';
        form.action = '@Url.Action("DeleteAllConfirmation", "Courses")';

        document.body.appendChild(form);
        form.submit();
    }

    // ========================
    // COLUMN APPLY BUTTON
    // ========================
    applyColumnsBtn.addEventListener('click', function () {
        columnToggles.forEach(t => {
            toggleColumn(t.dataset.column, t.checked);
        });
        saveColumnPreferences();
        bootstrap.Modal.getInstance(document.getElementById('columnModal')).hide();
    });

    // ========================
    // TOAST NOTIFICATIONS
    // ========================
    function showToast(message, type = 'info') {
        const toastContainer = document.getElementById('toastContainer') || createToastContainer();
        
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-white bg-${type} border-0`;
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');
        
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;
        
        toastContainer.appendChild(toast);
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
        
        // Remove toast after it's hidden
        toast.addEventListener('hidden.bs.toast', () => {
            toast.remove();
        });
    }

    function createToastContainer() {
        const container = document.createElement('div');
        container.id = 'toastContainer';
        container.className = 'toast-container position-fixed top-0 end-0 p-3';
        container.style.zIndex = '9999';
        document.body.appendChild(container);
        return container;
    }

    // ========================
    // INITIALIZATION
    // ========================
    loadColumnPreferences();
    updateSelectedCount();

    // Add individual delete button handlers
    document.querySelectorAll('.delete-course').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const courseId = this.dataset.courseId;
            const courseName = this.dataset.courseName;
            showDeleteConfirmation('single', courseId, courseName);
        });
    });

    // Handle export form submission
    document.getElementById('exportForm').addEventListener('submit', function(e) {
        const selectedIds = getSelectedCourseIds();
        if (selectedIds.length === 0) {
            e.preventDefault();
            showToast('Please select at least one course to export.', 'warning');
            return;
        }

        // Add selected IDs to form
        selectedIds.forEach(id => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'selectedCourses';
            input.value = id;
            this.appendChild(input);
        });
    });

}); // <-- This closes the document.addEventListener function

</script>
}