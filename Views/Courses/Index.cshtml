@model List<StudentManagementSystem.Models.Course>
@{
    ViewData["Title"] = "Course Management";
    var currentFilter = ViewData["CurrentFilter"] as string;
    var currentDepartment = ViewData["CurrentDepartment"] as string;
    var currentSemester = ViewData["CurrentSemester"] as int?;
    var currentSort = ViewData["CurrentSort"] as string;
    var currentOrder = ViewData["CurrentOrder"] as string;
    var importResult = TempData["ImportResult"] as string;
    var importedCount = TempData["ImportedCount"] as int? ?? 0;
    var errorCount = TempData["ErrorCount"] as int? ?? 0;

    string GetProgressBarColor(int percentage)
    {
        if (percentage >= 90) return "bg-danger";
        if (percentage >= 70) return "bg-warning";
        return "bg-success";
    }

    int serialNumber = 1;
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>
            <i class="fas fa-book me-2"></i>Course Management
        </h2>
        <div>
            <a href="@Url.Action("Create")" class="btn btn-primary">
                <i class="fas fa-plus me-1"></i>New Course
            </a>
            <a href="@Url.Action("Import")" class="btn btn-success">
                <i class="fas fa-file-import me-1"></i>Import Excel
            </a>
            <a href="@Url.Action("Export")" class="btn btn-info">
                <i class="fas fa-file-export me-1"></i>Export Excel
            </a>
            <a class="nav-link" href="@Url.Action("Manage", "Grades")">
                <i class="fas fa-graduation-cap"></i> Grade Management
            </a>
        </div>
    </div>

    <!-- Import Results Announcement -->
    @if (!string.IsNullOrEmpty(importResult))
    {
        <div class="alert alert-info alert-dismissible fade show" role="alert">
            <h5 class="alert-heading">
                <i class="fas fa-info-circle me-2"></i>Import Completed
            </h5>
            <p class="mb-1">@importResult</p>
            @if (importedCount > 0)
            {
                <p class="mb-1">
                    <i class="fas fa-check text-success me-1"></i>
                    <strong>@importedCount</strong> courses imported successfully
                </p>
            }
            @if (errorCount > 0)
            {
                <p class="mb-0">
                    <i class="fas fa-exclamation-triangle text-warning me-1"></i>
                    <strong>@errorCount</strong> errors encountered
                </p>
            }
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Courses Summary Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card border-start border-primary border-4">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <div class="text-muted small">Total Courses</div>
                            <div class="h4 mb-0 text-primary">@Model.Count</div>
                        </div>
                        <div class="flex-shrink-0">
                            <i class="fas fa-book fa-2x text-primary"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card border-start border-success border-4">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <div class="text-muted small">Active Courses</div>
                            <div class="h4 mb-0 text-success">@Model.Count(c => c.IsActive)</div>
                        </div>
                        <div class="flex-shrink-0">
                            <i class="fas fa-check-circle fa-2x text-success"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card border-start border-warning border-4">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <div class="text-muted small">Selected</div>
                            <div class="h4 mb-0 text-warning" id="selectedCountBadge">0</div>
                        </div>
                        <div class="flex-shrink-0">
                            <i class="fas fa-check-circle fa-2x text-warning"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card border-start border-info border-4">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <div class="text-muted small">Actions</div>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-info" id="selectAllBtn">
                                    <i class="fas fa-check-square me-1"></i>All
                                </button>
                                <button class="btn btn-outline-info" id="deselectAllBtn">
                                    <i class="fas fa-square me-1"></i>None
                                </button>
                                <button class="btn btn-outline-info" id="columnToggleBtn" data-bs-toggle="modal" data-bs-target="#columnModal">
                                    <i class="fas fa-columns me-1"></i>Columns
                                </button>
                            </div>
                        </div>
                        <div class="flex-shrink-0">
                            <i class="fas fa-cogs fa-2x text-info"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Actions Toolbar -->
    <div class="card mb-4" id="bulkActionsToolbar" style="display: none;">
        <div class="card-header bg-warning">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h5 class="mb-0 text-white">
                        <i class="fas fa-tools me-2"></i>Bulk Actions
                        <span class="badge bg-light text-dark ms-2" id="bulkSelectedCount">0</span>
                    </h5>
                </div>
                <div class="col-md-6 text-end">
                    <div class="btn-group">
                        <button type="button" class="btn btn-danger btn-sm" id="deleteSelectedBtn">
                            <i class="fas fa-trash me-1"></i>Delete Selected
                        </button>
                        <button type="button" class="btn btn-outline-danger btn-sm" id="deleteAllBtn">
                            <i class="fas fa-broom me-1"></i>Delete All
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="cancelBulkBtn">
                            <i class="fas fa-times me-1"></i>Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filters Card -->
    <!-- Search and Filters Card -->
<div class="card mb-4">
    <div class="card-header bg-light">
        <h5 class="mb-0">
            <i class="fas fa-filter"></i> Filters & Search
        </h5>
    </div>
    <div class="card-body">
        <form method="get" asp-action="Index" class="row g-3" id="filterForm">
            <!-- Search Input -->
            <div class="col-md-4">
                <label for="searchString" class="form-label">Search Courses</label>
                <div class="input-group">
                    <input type="text" 
                           name="searchString" 
                           class="form-control" 
                           placeholder="Search by code, name, description..."
                           value="@currentFilter" />
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
            
            <!-- Department Filter -->
            <div class="col-md-3">
                <label for="department" class="form-label">Department</label>
                <select name="department" class="form-select" id="departmentSelect">
                    <option value="">All Departments</option>
                    @foreach (var dept in Model.Select(c => c.Department).Distinct().OrderBy(d => d))
                    {
                        <option value="@dept" selected="@(currentDepartment == dept)">@dept</option>
                    }
                </select>
            </div>
            
            <!-- Semester Filter -->
            <div class="col-md-3">
                <label for="semester" class="form-label">Semester</label>
                <select name="semester" class="form-select" id="semesterSelect">
                    <option value="">All Semesters</option>
                    @foreach (var sem in Model.Select(c => c.Semester).Distinct().OrderBy(s => s))
                    {
                        <option value="@sem" selected="@(currentSemester?.ToString() == sem.ToString())">Semester @sem</option>
                    }
                </select>
            </div>
            
            <!-- Action Buttons -->
            <div class="col-md-2">
                <label class="form-label">&nbsp;</label>
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary flex-fill">
                        <i class="fas fa-filter"></i> Apply
                    </button>
                    @if (!string.IsNullOrEmpty(currentFilter) || !string.IsNullOrEmpty(currentDepartment) || currentSemester.HasValue)
                    {
                        <a href="@Url.Action("Index")" class="btn btn-outline-danger">
                            <i class="fas fa-times"></i>
                        </a>
                    }
                </div>
            </div>
            
            <!-- Hidden fields to preserve sorting -->
            <input type="hidden" name="sortBy" value="@currentSort" />
            <input type="hidden" name="sortOrder" value="@currentOrder" />
        </form>
        
        <!-- Active Filters Display -->
        @if (!string.IsNullOrEmpty(currentFilter) || !string.IsNullOrEmpty(currentDepartment) || currentSemester.HasValue)
        {
            <div class="mt-3 p-3 bg-light rounded">
                <small class="text-muted fw-bold">Active Filters:</small>
                <div class="d-flex flex-wrap gap-2 mt-2">
                    @if (!string.IsNullOrEmpty(currentFilter))
                    {
                        <span class="badge bg-primary">
                            <i class="fas fa-search me-1"></i> Search: "@currentFilter"
                            <a href="@Url.Action("Index", new { 
                                department = currentDepartment, 
                                semester = currentSemester,
                                sortBy = currentSort,
                                sortOrder = currentOrder
                            })" class="text-white ms-2">
                                <i class="fas fa-times"></i>
                            </a>
                        </span>
                    }
                    @if (!string.IsNullOrEmpty(currentDepartment))
                    {
                        <span class="badge bg-info">
                            <i class="fas fa-building me-1"></i> Department: @currentDepartment
                            <a href="@Url.Action("Index", new { 
                                searchString = currentFilter, 
                                semester = currentSemester,
                                sortBy = currentSort,
                                sortOrder = currentOrder
                            })" class="text-white ms-2">
                                <i class="fas fa-times"></i>
                            </a>
                        </span>
                    }
                    @if (currentSemester.HasValue)
                    {
                        <span class="badge bg-warning text-dark">
                            <i class="fas fa-calendar me-1"></i> Semester: @currentSemester
                            <a href="@Url.Action("Index", new { 
                                searchString = currentFilter, 
                                department = currentDepartment,
                                sortBy = currentSort,
                                sortOrder = currentOrder
                            })" class="text-dark ms-2">
                                <i class="fas fa-times"></i>
                            </a>
                        </span>
                    }
                </div>
            </div>
        }
        
        <!-- DEBUG: Remove this after testing -->
        <div class="mt-3 alert alert-info">
            <h6 class="mb-2">Debug Info (Current Values):</h6>
            <div class="row small">
                <div class="col-md-3">
                    <strong>searchString:</strong> @(string.IsNullOrEmpty(currentFilter) ? "null" : $"\"{currentFilter}\"")
                </div>
                <div class="col-md-3">
                    <strong>department:</strong> @(string.IsNullOrEmpty(currentDepartment) ? "null" : $"\"{currentDepartment}\"")
                </div>
                <div class="col-md-3">
                    <strong>semester:</strong> @(currentSemester?.ToString() ?? "null")
                </div>
                <div class="col-md-3">
                    <strong>Results:</strong> @Model.Count courses
                </div>
            </div>
        </div>
    </div>
</div>

    <!-- Courses Table Container -->
    <div class="card">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-table"></i> Courses List
                <span class="badge bg-primary ms-2">@Model.Count Total</span>
            </h5>
            <div class="btn-group">
                <form id="exportForm" asp-action="ExportSelected" method="post" class="d-inline">
                    <button type="submit" class="btn btn-outline-info btn-sm" id="exportSelectedBtn">
                        <i class="fas fa-download"></i> Export Selected
                    </button>
                </form>
                <button class="btn btn-outline-success btn-sm" id="quickEnrollBtn" style="display: none;">
                    <i class="fas fa-user-plus"></i> Quick Enroll
                </button>
            </div>
        </div>

        <!-- Scrollable Table Container -->
        <div class="table-container" style="max-height: 70vh; overflow: auto;">
            <table class="table table-striped table-hover table-bordered mb-0" id="coursesTable">
                <thead class="table-dark sticky-top">
                    <tr>
                        <th class="column-checkbox text-center" width="50">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="selectAll">
                            </div>
                        </th>
                        <th class="column-serial text-center sortable" data-sort="serial">
                            <a href="@Url.Action("Index", new { sortBy = "Serial", sortOrder = currentSort == "Serial" && currentOrder == "asc" ? "desc" : "asc", searchString = currentFilter })" class="text-white text-decoration-none">
                                #
                                @if (currentSort == "Serial")
                                {
                                    <i class="fas @(currentOrder == "asc" ? "fa-sort-up" : "fa-sort-down")"></i>
                                }
                                else
                                {
                                    <i class="fas fa-sort"></i>
                                }
                            </a>
                        </th>
                        <th class="column-code sortable" data-sort="coursecode">
                            <a href="@Url.Action("Index", new { sortBy = "CourseCode", sortOrder = currentSort == "CourseCode" && currentOrder == "asc" ? "desc" : "asc", searchString = currentFilter })" class="text-white text-decoration-none">
                                Course Code
                                @if (currentSort == "CourseCode")
                                {
                                    <i class="fas @(currentOrder == "asc" ? "fa-sort-up" : "fa-sort-down")"></i>
                                }
                                else
                                {
                                    <i class="fas fa-sort"></i>
                                }
                            </a>
                        </th>
                        <th class="column-name sortable" data-sort="coursename">
                            <a href="@Url.Action("Index", new { sortBy = "CourseName", sortOrder = currentSort == "CourseName" && currentOrder == "asc" ? "desc" : "asc", searchString = currentFilter })" class="text-white text-decoration-none">
                                Course Name
                                @if (currentSort == "CourseName")
                                {
                                    <i class="fas @(currentOrder == "asc" ? "fa-sort-up" : "fa-sort-down")"></i>
                                }
                                else
                                {
                                    <i class="fas fa-sort"></i>
                                }
                            </a>
                        </th>
                        <th class="column-description sortable">
                            <a href="@Url.Action("Index", new { sortBy = "Description", sortOrder = currentSort == "Description" && currentOrder == "asc" ? "desc" : "asc", searchString = currentFilter })" class="text-white text-decoration-none">
                                Description
                                @if (currentSort == "Description")
                                {
                                    <i class="fas @(currentOrder == "asc" ? "fa-sort-up" : "fa-sort-down")"></i>
                                }
                                else
                                {
                                    <i class="fas fa-sort"></i>
                                }
                            </a>
                        </th>
                       <th class="column-prerequisites sortable" data-sort="prerequisites">
                            <a href="@Url.Action("Index", new { sortBy = "Prerequisites", sortOrder = currentSort == "Prerequisites" && currentOrder == "asc" ? "desc" : "asc", searchString = currentFilter })" class="text-white text-decoration-none">
                                Prerequisites
                                @if (currentSort == "Prerequisites")
                                {
                                    <i class="fas @(currentOrder == "asc" ? "fa-sort-up" : "fa-sort-down")"></i>
                                }
                                else
                                {
                                    <i class="fas fa-sort"></i>
                                }
                            </a>
                        </th>
                        <th class="column-credits text-center sortable" data-sort="credits">
                            <a href="@Url.Action("Index", new { sortBy = "Credits", sortOrder = currentSort == "Credits" && currentOrder == "asc" ? "desc" : "asc", searchString = currentFilter })" class="text-white text-decoration-none">
                                Credits
                                @if (currentSort == "Credits")
                                {
                                    <i class="fas @(currentOrder == "asc" ? "fa-sort-up" : "fa-sort-down")"></i>
                                }
                                else
                                {
                                    <i class="fas fa-sort"></i>
                                }
                            </a>
                        </th>
                        <th class="column-department sortable" data-sort="department">
                            <a href="@Url.Action("Index", new { sortBy = "Department", sortOrder = currentSort == "Department" && currentOrder == "asc" ? "desc" : "asc", searchString = currentFilter })" class="text-white text-decoration-none">
                                Department
                                @if (currentSort == "Department")
                                {
                                    <i class="fas @(currentOrder == "asc" ? "fa-sort-up" : "fa-sort-down")"></i>
                                }
                                else
                                {
                                    <i class="fas fa-sort"></i>
                                }
                            </a>
                        </th>
                        <th class="column-semester text-center sortable" data-sort="semester">
                            <a href="@Url.Action("Index", new { sortBy = "Semester", sortOrder = currentSort == "Semester" && currentOrder == "asc" ? "desc" : "asc", searchString = currentFilter })" class="text-white text-decoration-none">
                                Semester
                                @if (currentSort == "Semester")
                                {
                                    <i class="fas @(currentOrder == "asc" ? "fa-sort-up" : "fa-sort-down")"></i>
                                }
                                else
                                {
                                    <i class="fas fa-sort"></i>
                                }
                            </a>
                        </th>
                        <th class="column-enrollment text-center sortable" data-sort="enrollment">
                            <a href="@Url.Action("Index", new { sortBy = "Enrollment", sortOrder = currentSort == "Enrollment" && currentOrder == "asc" ? "desc" : "asc", searchString = currentFilter })" class="text-white text-decoration-none">
                                Enrollment
                                @if (currentSort == "Enrollment")
                                {
                                    <i class="fas @(currentOrder == "asc" ? "fa-sort-up" : "fa-sort-down")"></i>
                                }
                                else
                                {
                                    <i class="fas fa-sort"></i>
                                }
                            </a>
                        </th>
                        <th class="column-status text-center sortable" data-sort="status">
                            <a href="@Url.Action("Index", new { sortBy = "Status", sortOrder = currentSort == "Status" && currentOrder == "asc" ? "desc" : "asc", searchString = currentFilter })" class="text-white text-decoration-none">
                                Status
                                @if (currentSort == "Status")
                                {
                                    <i class="fas @(currentOrder == "asc" ? "fa-sort-up" : "fa-sort-down")"></i>
                                }
                                else
                                {
                                    <i class="fas fa-sort"></i>
                                }
                            </a>
                        </th>
                        <th class="column-actions text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                @foreach (var course in Model)
                {
                    <tr>
                        <td class="column-checkbox text-center">
                            <div class="form-check">
                                <input class="form-check-input course-checkbox" type="checkbox" name="selectedCourses" value="@course.Id" data-course-name="@course.CourseName">
                            </div>
                        </td>
                        <td class="column-serial text-center">@serialNumber</td>
                        <td class="column-code fw-bold">@course.CourseCode</td>
                        <td class="column-name text-nowrap">@course.CourseName</td>
                        <td class="column-description">
                            @if (!string.IsNullOrEmpty(course.Description))
                            {
                                <div class="description-truncate">
                                    @if (course.Description.Length > 100)
                                    {
                                        <span class="truncated-text" 
                                              data-bs-toggle="tooltip" 
                                              data-bs-placement="top" 
                                              title="@course.Description">
                                            @course.Description.Substring(0, 100)...
                                        </span>
                                        <button type="button" 
                                                class="btn btn-sm btn-link p-0 ms-1 view-full-description"
                                                data-description="@course.Description">
                                            <i class="fas fa-expand-alt"></i>
                                        </button>
                                    }
                                    else
                                    {
                                        <span data-bs-toggle="tooltip" title="@course.Description">
                                            @course.Description
                                        </span>
                                    }
                                </div>
                            }
                            else
                            {
                                <span class="text-muted">No description</span>
                            }
                        </td>
                        <td class="column-prerequisites text-center">
                            @if (!string.IsNullOrEmpty(course.PrerequisitesString))
                            {
                                <div class="prerequisites-list">
                                    @{
                                        var prereqCodes = course.PrerequisitesString.Split(',')
                                            .Select(p => p.Trim())
                                            .Where(p => !string.IsNullOrEmpty(p))
                                            .Take(3);
                                    }
                                    @foreach (var prereqCode in prereqCodes)
                                    {
                                        <span class="badge bg-secondary me-1 mb-1" 
                                              data-bs-toggle="tooltip" 
                                              title="@prereqCode">
                                            @prereqCode
                                        </span>
                                    }
                                    @if (course.PrerequisitesString.Split(',').Length > 3)
                                    {
                                        <span class="badge bg-light text-dark">+@(course.PrerequisitesString.Split(',').Length - 3) more</span>
                                    }
                                </div>
                            }
                            else
                            {
                                <span class="text-muted">None</span>
                            }
                        </td>
                        <td class="column-credits text-center">
                            <span class="badge bg-info">@course.Credits</span>
                        </td>
                        <td class="column-department">@course.Department</td>
                        <td class="column-semester text-center">
                            <span class="badge bg-secondary">@course.Semester</span>
                        </td>
                        <td class="column-enrollment text-center">
                            @{
                                var enrollmentPercentage = course.MaxStudents > 0 ?
                                (int)((course.CurrentEnrollment * 100.0) / course.MaxStudents) : 0;
                                var availableSeats = course.MaxStudents - course.CurrentEnrollment;
                            }
                            <div class="enrollment-info">
                                <div class="progress mb-1" style="height: 6px;" title="@enrollmentPercentage% Full">
                                    <div class="progress-bar @GetProgressBarColor(enrollmentPercentage)"
                                         style="width: @enrollmentPercentage%">
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between small">
                                    <span class="text-muted">@course.CurrentEnrollment/@course.MaxStudents</span>
                                    <span class="text-success">@availableSeats seats left</span>
                                </div>
                            </div>
                        </td>
                        <td class="column-status text-center">
                            @if (course.IsActive)
                            {
                                <span class="badge bg-success">
                                    <i class="fas fa-check-circle me-1"></i>Active
                                </span>
                            }
                            else
                            {
                                <span class="badge bg-secondary">
                                    <i class="fas fa-times-circle me-1"></i>Inactive
                                </span>
                            }
                        </td>
                        <td class="column-actions text-center">
                            <div class="btn-group btn-group-sm" role="group">
                                <a href="@Url.Action("Details", new { id = course.Id })" class="btn btn-info" title="View Details" data-bs-toggle="tooltip">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a href="@Url.Action("Edit", new { id = course.Id })" class="btn btn-warning" title="Edit Course" data-bs-toggle="tooltip">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <a href="@Url.Action("Enroll", new { id = course.Id })" class="btn btn-success" title="Manage Enrollment" data-bs-toggle="tooltip">
                                    <i class="fas fa-user-plus"></i>
                                </a>
                                <a href="@Url.Action("Delete", new { id = course.Id })" class="btn btn-danger delete-course" title="Delete Course" data-bs-toggle="tooltip" data-course-id="@course.Id" data-course-name="@course.CourseName">
                                    <i class="fas fa-trash"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    serialNumber++;
                }
            </tbody>
            </table>
        </div>

        <!-- Empty State -->
        @if (!Model.Any())
        {
            <div class="card-body text-center py-5">
                <i class="fas fa-book-open fa-4x text-muted mb-3"></i>
                <h4 class="text-muted">No Courses Found</h4>
                <p class="text-muted mb-4">No courses match your current filters.</p>
                <div class="d-flex justify-content-center gap-2">
                    <a href="@Url.Action("Create")" class="btn btn-primary">
                        <i class="fas fa-plus me-1"></i>Create First Course
                    </a>
                    <a href="@Url.Action("Index")" class="btn btn-outline-secondary">
                        <i class="fas fa-times me-1"></i>Clear Filters
                    </a>
                </div>
            </div>
        }
    </div>
</div>

<!-- Column Customization Modal -->
<div class="modal fade" id="columnModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-columns me-2"></i>Customize Columns
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-3">Select which columns to display in the table:</p>
                <div class="form-check mb-2">
                    <input class="form-check-input column-toggle" type="checkbox" id="toggleDescription" data-column="description" checked>
                    <label class="form-check-label" for="toggleDescription">Description</label>
                </div>
                <div class="form-check mb-2">
                    <input class="form-check-input column-toggle" type="checkbox" id="toggleDepartment" data-column="department" checked>
                    <label class="form-check-label" for="toggleDepartment">Department</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="autoSaveColumns">
                    <label class="form-check-label" for="autoSaveColumns">Remember my preferences</label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="applyColumns">Apply</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>Confirm Deletion
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="deleteSingleContent">
                    <p>Are you sure you want to delete course <strong id="deleteCourseName"></strong>?</p>
                    <p class="text-muted small">This action cannot be undone.</p>
                </div>
                <div id="deleteMultipleContent" style="display: none;">
                    <p>Are you sure you want to delete <strong id="deleteCount">0</strong> selected courses?</p>
                    <div id="deleteCourseList" class="small text-muted mt-2" style="max-height: 100px; overflow-y: auto;"></div>
                    <p class="text-danger mt-2"><i class="fas fa-exclamation-circle me-1"></i>This action cannot be undone!</p>
                </div>
                <div id="deleteAllContent" style="display: none;">
                    <div class="alert alert-warning">
                        <h6><i class="fas fa-radiation me-2"></i>Danger Zone</h6>
                        <p class="mb-0">You are about to delete <strong>ALL @Model.Count courses</strong> from the system!</p>
                    </div>
                    <p class="text-danger">
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        <strong>Warning:</strong> This action is irreversible and will permanently remove all course records.
                    </p>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="confirmDeleteAll">
                        <label class="form-check-label text-danger" for="confirmDeleteAll">
                            I understand this action cannot be undone
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteForm" method="post" style="display: inline;">
                    <button type="submit" class="btn btn-danger" id="confirmDeleteBtn" disabled>Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Full Description Modal -->
<div class="modal fade" id="descriptionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Course Description</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="fullDescriptionContent" style="white-space: pre-wrap; word-wrap: break-word;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        .table-container {
            position: relative;
            border: 1px solid #dee2e6;
        }

        .sticky-top {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .table th {
            position: relative;
            cursor: pointer;
            white-space: nowrap;
            background-color: #343a40;
            color: white;
        }

            .table th a {
                text-decoration: none;
                color: inherit;
                display: block;
            }

            .table th:hover {
                background-color: #495057;
            }

        .sortable {
            cursor: pointer;
            user-select: none;
        }

        /* ✅ FIXED: Change from auto to fixed layout */
        #coursesTable {
            table-layout: fixed;
            width: 100%;
            margin-bottom: 0;
        }

        /* ✅ COMPLETE COLUMN WIDTH DEFINITIONS */
        .column-checkbox { width: 50px; min-width: 50px; max-width: 50px; }
        .column-serial { width: 70px; min-width: 70px; max-width: 70px; }
        .column-code { width: 100px; min-width: 100px; max-width: 100px; }
        .column-name { width: 200px; min-width: 200px; max-width: 200px; }
        .column-description { width: 200px; min-width: 200px; max-width: 200px; }
        .column-prerequisites { width: 150px; min-width: 150px; max-width: 150px; }
        .column-credits { width: 80px; min-width: 80px; max-width: 80px; }
        .column-department { width: 120px; min-width: 120px; max-width: 120px; }
        .column-semester { width: 100px; min-width: 100px; max-width: 100px; }
        .column-enrollment { width: 120px; min-width: 120px; max-width: 120px; }
        .column-status { width: 100px; min-width: 100px; max-width: 100px; }
        .column-actions { width: 180px; min-width: 180px; max-width: 180px; }

        /* ✅ FIXED: Ensure proper text handling for ALL columns */
        #coursesTable td {
            word-wrap: break-word;
            vertical-align: middle;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* ✅ ALLOW DESCRIPTION TO WRAP PROPERLY */
        .column-description {
            white-space: normal !important;
            line-height: 1.3;
            max-height: 60px;
            overflow: hidden;
        }

        /* Hover effects */
        #coursesTable tbody tr:hover {
            background-color: rgba(0, 123, 255, 0.1);
        }

        /* Checkbox styling */
        .form-check-input:checked {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }

        /* Action buttons */
        .btn-group-sm > .btn {
            padding: 0.25rem 0.5rem;
        }

        /* Progress bar styling */
        .progress {
            background-color: #e9ecef;
            border-radius: 0.375rem;
        }

        .progress-bar {
            border-radius: 0.375rem;
            transition: width 0.3s ease;
        }

        /* Bulk actions toolbar */
        #bulkActionsToolbar {
            transition: all 0.3s ease;
        }

        /* Enrollment info */
        .enrollment-info {
            min-width: 100px;
        }

        /* Custom scrollbar for table container */
        .table-container::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .table-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

            .table-container::-webkit-scrollbar-thumb:hover {
                background: #a8a8a8;
            }

        /* Column hiding */
        .column-description, .column-department {
            transition: all 0.3s ease;
        }

        /* Responsive adjustments */
        @@media (max-width: 768px) {
            .table-container {
                max-height: 50vh;
            }

            .btn-group-sm > .btn {
                padding: 0.2rem 0.4rem;
            }

            #coursesTable {
                font-size: 0.875rem;
            }

            /* ✅ MOBILE: Adjust column widths for smaller screens */
            .column-code { width: 80px; min-width: 80px; }
            .column-name { width: 150px; min-width: 150px; }
            .column-description { width: 120px; min-width: 120px; }
            .column-prerequisites { width: 100px; min-width: 100px; }
        }

        .course-description {
            max-width: 300px;
            display: inline-block;
            vertical-align: middle;
        }
    
        /* Ensure text wraps properly */
        .modal-body {
            word-wrap: break-word;
            white-space: pre-wrap;
            max-height: 60vh;
            overflow-y: auto;
        }
    
        /* Textarea styling */
        textarea.form-control {
            resize: vertical;
            min-height: 120px;
        }
    </style>
}

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Initialize tooltips
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });

            // Selection functionality
            const selectAll = document.getElementById('selectAll');
            const courseCheckboxes = document.querySelectorAll('.course-checkbox');
            const selectedCountBadge = document.getElementById('selectedCountBadge');
            const bulkSelectedCount = document.getElementById('bulkSelectedCount');
            const bulkActionsToolbar = document.getElementById('bulkActionsToolbar');
            const selectAllBtn = document.getElementById('selectAllBtn');
            const deselectAllBtn = document.getElementById('deselectAllBtn');
            const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
            const deleteAllBtn = document.getElementById('deleteAllBtn');
            const cancelBulkBtn = document.getElementById('cancelBulkBtn');
            const exportSelectedBtn = document.getElementById('exportSelectedBtn');
            const quickEnrollBtn = document.getElementById('quickEnrollBtn');
            const columnToggleBtn = document.getElementById('columnToggleBtn');
            const applyColumnsBtn = document.getElementById('applyColumns');
            const columnToggles = document.querySelectorAll('.column-toggle');
            const autoSaveColumns = document.getElementById('autoSaveColumns');

            // Modal elements
            const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
            const deleteCourseName = document.getElementById('deleteCourseName');
            const deleteCount = document.getElementById('deleteCount');
            const deleteCourseList = document.getElementById('deleteCourseList');
            const confirmDeleteAll = document.getElementById('confirmDeleteAll');
            const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
            const deleteForm = document.getElementById('deleteForm');
            const deleteSingleContent = document.getElementById('deleteSingleContent');
            const deleteMultipleContent = document.getElementById('deleteMultipleContent');
            const deleteAllContent = document.getElementById('deleteAllContent');

            let currentDeleteAction = '';
            let currentCourseId = null;

            // Load column preferences from localStorage
            function loadColumnPreferences() {
                const savedColumns = localStorage.getItem('courseTableColumns');
                if (savedColumns) {
                    const columns = JSON.parse(savedColumns);
                    columnToggles.forEach(toggle => {
                        const column = toggle.dataset.column;
                        toggle.checked = columns[column] !== false;
                        toggleColumn(column, toggle.checked);
                    });
                    autoSaveColumns.checked = true;
                }
            }

            // Save column preferences to localStorage
            function saveColumnPreferences() {
                if (autoSaveColumns.checked) {
                    const columns = {};
                    columnToggles.forEach(toggle => {
                        columns[toggle.dataset.column] = toggle.checked;
                    });
                    localStorage.setItem('courseTableColumns', JSON.stringify(columns));
                }
            }

            // Toggle column visibility
            function toggleColumn(column, show) {
                const headerCells = document.querySelectorAll(`th.column-${column}`);
                const dataCells = document.querySelectorAll(`td.column-${column}`);

                headerCells.forEach(cell => {
                    cell.style.display = show ? '' : 'none';
                });
                dataCells.forEach(cell => {
                    cell.style.display = show ? '' : 'none';
                });
            }

            function updateSelectedCount() {
                const selected = document.querySelectorAll('.course-checkbox:checked').length;
                selectedCountBadge.textContent = selected;
                bulkSelectedCount.textContent = selected;

                // Show/hide bulk actions toolbar
                if (selected > 0) {
                    bulkActionsToolbar.style.display = 'block';
                    quickEnrollBtn.style.display = 'inline-block';
                } else {
                    bulkActionsToolbar.style.display = 'none';
                    quickEnrollBtn.style.display = 'none';
                }

                // Enable/disable export button
                exportSelectedBtn.disabled = selected === 0;
            }

            function selectAllCourses(select) {
                courseCheckboxes.forEach(checkbox => {
                    checkbox.checked = select;
                });
                selectAll.checked = select;
                updateSelectedCount();
            }

            function getSelectedCourseIds() {
                const selectedIds = [];
                courseCheckboxes.forEach(checkbox => {
                    if (checkbox.checked) {
                        selectedIds.push(checkbox.value);
                    }
                });
                return selectedIds;
            }

            function getSelectedCourses() {
                const selected = [];
                courseCheckboxes.forEach(checkbox => {
                    if (checkbox.checked) {
                        selected.push({
                            id: checkbox.value,
                            name: checkbox.dataset.courseName
                        });
                    }
                });
                return selected;
            }

            function showDeleteConfirmation(action, courseId = null, courseName = null) {
                currentDeleteAction = action;
                currentCourseId = courseId;

                // Reset modal state
                deleteSingleContent.style.display = 'none';
                deleteMultipleContent.style.display = 'none';
                deleteAllContent.style.display = 'none';
                confirmDeleteAll.checked = false;
                confirmDeleteBtn.disabled = true;

                if (action === 'single') {
                    deleteSingleContent.style.display = 'block';
                    deleteCourseName.textContent = courseName;
                    confirmDeleteBtn.disabled = false;
                }
                else if (action === 'multiple') {
                    const selected = getSelectedCourses();
                    deleteMultipleContent.style.display = 'block';
                    deleteCount.textContent = selected.length;

                    // Show course names
                    deleteCourseList.innerHTML = '';
                    selected.forEach(course => {
                        const div = document.createElement('div');
                        div.className = 'border-bottom pb-1 mb-1';
                        div.textContent = course.name;
                        deleteCourseList.appendChild(div);
                    });
                    confirmDeleteBtn.disabled = false;
                }
                else if (action === 'all') {
                    deleteAllContent.style.display = 'block';
                    confirmDeleteBtn.disabled = true;
                }

                deleteModal.show();
            }

            // Event listeners
            selectAll.addEventListener('change', function () {
                selectAllCourses(this.checked);
            });

            courseCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function () {
                    // Update select all checkbox state
                    const allChecked = document.querySelectorAll('.course-checkbox:checked').length === courseCheckboxes.length;
                    selectAll.checked = allChecked;
                    updateSelectedCount();
                });
            });

            selectAllBtn.addEventListener('click', function () {
                selectAllCourses(true);
            });

            deselectAllBtn.addEventListener('click', function () {
                selectAllCourses(false);
            });

            deleteSelectedBtn.addEventListener('click', function () {
                const selected = getSelectedCourses();
                if (selected.length > 0) {
                    showDeleteConfirmation('multiple');
                } else {
                    alert('Please select at least one course to delete.');
                }
            });

            deleteAllBtn.addEventListener('click', function () {
                if (@Model.Count > 0) {
                    showDeleteConfirmation('all');
                } else {
                    alert('No courses found to delete.');
                }
            });

            cancelBulkBtn.addEventListener('click', function () {
                selectAllCourses(false);
            });

            // Individual delete buttons - FIXED: Proper event handling
            document.querySelectorAll('a.delete-course').forEach(link => {
                link.addEventListener('click', function (e) {
                    e.preventDefault();
                    const courseId = this.getAttribute('href').split('/').pop();
                    const courseName = this.closest('tr').querySelector('td:nth-child(4)').textContent.trim();
                    showDeleteConfirmation('single', courseId, courseName);
                });
            });

            // Quick enroll button
            quickEnrollBtn.addEventListener('click', function () {
                const selected = getSelectedCourses();
                if (selected.length > 0) {
                    // Implement quick enroll functionality
                    alert(`Quick enroll for ${selected.length} courses would be implemented here`);
                }
            });

            // Delete all confirmation checkbox
            confirmDeleteAll.addEventListener('change', function () {
                confirmDeleteBtn.disabled = !this.checked;
            });

            // Confirm delete button handler - FIXED: Proper form submission
            confirmDeleteBtn.addEventListener('click', function () {
                if (currentDeleteAction === 'single') {
                    // Redirect to single delete action
                    window.location.href = `@Url.Action("Delete")/${currentCourseId}`;
                }
                else if (currentDeleteAction === 'multiple') {
                    // Submit bulk delete form
                    const selectedIds = getSelectedCourseIds();
                    submitBulkDelete(selectedIds);
                }
                else if (currentDeleteAction === 'all') {
                    // Submit delete all form
                    submitDeleteAll();
                }
            });

            // Bulk delete submission
            function submitBulkDelete(selectedIds) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '@Url.Action("DeleteMultiple")';

                // Add anti-forgery token
                const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
                const tokenInput = document.createElement('input');
                tokenInput.type = 'hidden';
                tokenInput.name = '__RequestVerificationToken';
                tokenInput.value = token;
                form.appendChild(tokenInput);

                // Add selected course IDs
                selectedIds.forEach(id => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'selectedCourses';
                    input.value = id;
                    form.appendChild(input);
                });

                document.body.appendChild(form);
                form.submit();
            }

            // Delete all submission
            function submitDeleteAll() {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '@Url.Action("DeleteAll")';

                // Add anti-forgery token
                const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
                const tokenInput = document.createElement('input');
                tokenInput.type = 'hidden';
                tokenInput.name = '__RequestVerificationToken';
                tokenInput.value = token;
                form.appendChild(tokenInput);

                document.body.appendChild(form);
                form.submit();
            }

            // Export form submission
            document.getElementById('exportForm').addEventListener('submit', function (e) {
                const selectedCount = document.querySelectorAll('.course-checkbox:checked').length;
                if (selectedCount === 0) {
                    e.preventDefault();
                    alert('Please select at least one course to export.');
                    return false;
                }
                return confirm(`Export ${selectedCount} selected courses?`);
            });

            // Column customization
            applyColumnsBtn.addEventListener('click', function () {
                columnToggles.forEach(toggle => {
                    const column = toggle.dataset.column;
                    toggleColumn(column, toggle.checked);
                });
                saveColumnPreferences();
                bootstrap.Modal.getInstance(document.getElementById('columnModal')).hide();
            });

            // Initialize column preferences
            loadColumnPreferences();

            // Auto-resize columns
            function autoResizeColumns() {
                const table = document.getElementById('coursesTable');
                if (!table) return;

                const headers = table.querySelectorAll('thead th');
                headers.forEach((header, index) => {
                    if (header.style.display === 'none') return;

                    let maxWidth = 0;
                    const cells = table.querySelectorAll(`tbody td:nth-child(${index + 1})`);

                    cells.forEach(cell => {
                        if (cell.style.display === 'none') return;
                        const width = cell.textContent.length * 8 + 20;
                        if (width > maxWidth) {
                            maxWidth = width;
                        }
                    });

                    // Set reasonable limits
                    if (index === 0) maxWidth = Math.min(maxWidth, 50);  // Checkbox
                    if (index === 1) maxWidth = Math.min(maxWidth, 70);  // Serial
                    if (index === 5) maxWidth = Math.min(maxWidth, 80);  // Credits
                    if (index === 7) maxWidth = Math.min(maxWidth, 100); // Semester
                    if (index === 8) maxWidth = Math.min(maxWidth, 120); // Enrollment
                    if (index === 9) maxWidth = Math.min(maxWidth, 100); // Status
                    if (index === 10) maxWidth = Math.min(maxWidth, 180); // Actions

                    header.style.minWidth = maxWidth + 'px';
                });
            }

            // Initialize
            autoResizeColumns();
            updateSelectedCount();

            // Auto-hide import alert after 10 seconds
            setTimeout(() => {
                const alerts = document.querySelectorAll('.alert');
                alerts.forEach(alert => {
                    alert.style.transition = 'opacity 0.5s ease';
                    alert.style.opacity = '0';
                    setTimeout(() => alert.remove(), 500);
                });
            }, 10000);

            // Enhance table sorting visual feedback
            document.querySelectorAll('.sortable').forEach(header => {
                header.addEventListener('click', function () {
                    // Add visual feedback for sorting
                    this.style.backgroundColor = '#495057';
                    setTimeout(() => {
                        this.style.backgroundColor = '';
                    }, 200);
                });
            });
        });
    </script>

    <script>
    // View full description
    document.addEventListener('DOMContentLoaded', function() {
        // Tooltip initialization
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        // Full description modal
        const viewButtons = document.querySelectorAll('.view-full-description');
        const modal = new bootstrap.Modal(document.getElementById('descriptionModal'));
        const content = document.getElementById('fullDescriptionContent');

        viewButtons.forEach(button => {
            button.addEventListener('click', function() {
                const description = this.getAttribute('data-description');
                content.textContent = description;
                modal.show();
            });
        });
    });


    // Add this to your existing JavaScript section
document.addEventListener('DOMContentLoaded', function () {
    // Auto-submit form when dropdowns change
    const departmentSelect = document.getElementById('departmentSelect');
    const semesterSelect = document.getElementById('semesterSelect');
    
    if (departmentSelect) {
        departmentSelect.addEventListener('change', function() {
            document.getElementById('filterForm').submit();
        });
    }
    
    if (semesterSelect) {
        semesterSelect.addEventListener('change', function() {
            document.getElementById('filterForm').submit();
        });
    }
    
    // Real-time search with debounce
    const searchInput = document.querySelector('input[name="searchString"]');
    if (searchInput) {
        let searchTimeout;
        
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                // Show loading state
                const submitBtn = document.querySelector('#filterForm button[type="submit"]');
                const originalHtml = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                submitBtn.disabled = true;
                
                // Submit form after typing stops
                document.getElementById('filterForm').submit();
            }, 800);
        });
    }
});

</script>
}