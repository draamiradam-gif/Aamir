@model List<StudentManagementSystem.Models.WaitlistEntry>
@{
    ViewData["Title"] = "Waitlist Management";
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>
            <i class="fas fa-clock me-2"></i>Waitlist Management
        </h2>
        <div class="btn-group">
            <button class="btn btn-success" id="processAllWaitlists">
                <i class="fas fa-cog me-1"></i> Process All Waitlists
            </button>
            <a href="@Url.Action("Dashboard")" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-1"></i> Back to Dashboard
            </a>
        </div>
    </div>

    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Semester</label>
                    <select class="form-select" id="semesterFilter">
                        <option value="0">All Semesters</option>
                        <!-- Will be populated by JavaScript -->
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Course</label>
                    <select class="form-select" id="courseFilter">
                        <option value="0">All Courses</option>
                        <!-- Will be populated by JavaScript -->
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Status</label>
                    <select class="form-select" id="statusFilter">
                        <option value="all">All Status</option>
                        <option value="active">Active Only</option>
                        <option value="expired">Expired</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Waitlist Entries -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Waitlist Entries</h5>
            <span class="badge bg-primary" id="waitlistCount">@(Model?.Count ?? 0) entries</span> @* FIX: Null check *@
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0" id="waitlistTable">
                    <thead class="table-light">
                        <tr>
                            <th>Position</th>
                            <th>Student</th>
                            <th>Course</th>
                            <th>Semester</th>
                            <th>Added Date</th>
                            <th>Status</th>
                            <th width="150">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model != null) @* FIX: Add null check *@
                        {
                            @foreach (var entry in Model)
                            {
                                <tr data-entry-id="@entry.Id" data-course-id="@entry.CourseId" data-semester-id="@entry.SemesterId">
                                    <td class="fw-bold">#@entry.Position</td>
                                    <td>@entry.Student?.Name</td> @* FIX: Null check *@
                                    <td>@entry.Course?.CourseCode - @entry.Course?.CourseName</td> @* FIX: Null check *@
                                    <td>@entry.Semester?.Name</td> @* FIX: Null check *@
                                    <td>@entry.AddedDate.ToString("MMM dd, yyyy")</td>
                                    <td>
                                        @if (entry.IsActive)
                                        {
                                            <span class="badge bg-success">Active</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary">Inactive</span>
                                        }
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary enroll-from-waitlist"
                                                    title="Enroll Student"
                                                    data-student-id="@entry.StudentId"
                                                    data-course-id="@entry.CourseId"
                                                    data-semester-id="@entry.SemesterId">
                                                <i class="fas fa-user-plus"></i>
                                            </button>
                                            <button class="btn btn-outline-warning notify-student"
                                                    title="Notify Student"
                                                    data-student-email="@entry.Student?.Email">
                                                @* FIX: Null check *@
                                                <i class="fas fa-bell"></i>
                                            </button>
                                            <button class="btn btn-outline-danger remove-waitlist"
                                                    title="Remove from Waitlist"
                                                    data-entry-id="@entry.Id">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="7" class="text-center text-muted">No waitlist entries found</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    <script>
        $(document).ready(function() {
            // Load filters - FIXED: Use MVC endpoints for dropdown data
            loadSemesters();
            loadCourses();

            // Process all waitlists - FIXED: Use API endpoint
            $('#processAllWaitlists').on('click', function() {
                const btn = $(this);
                btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i> Processing...');

                // Use API endpoint
                $.post('@Url.Action("ProcessAllWaitlists", "Enrollment")')  // CHANGED: Using 0/0 for "all"
                    .done(function(result) {
                        showToast('Success', 'All waitlists processed successfully!', 'success');
                        setTimeout(() => location.reload(), 2000);
                    })
                    .fail(function(xhr, status, error) {
                        showToast('Error', 'Failed to process waitlists: ' + error, 'error');
                    })
                    .always(function() {
                        btn.prop('disabled', false).html('<i class="fas fa-cog me-1"></i> Process All Waitlists');
                    });
            });

            // Enroll from waitlist - FIXED: Use API endpoint
            $('.enroll-from-waitlist').on('click', function() {
                const studentId = $(this).data('student-id');
                const courseId = $(this).data('course-id');
                const semesterId = $(this).data('semester-id');
                const btn = $(this);

                enrollFromWaitlist(studentId, courseId, semesterId, btn);
            });

            // Remove from waitlist - FIXED: Use MVC endpoint (this is a view operation)
            $('.remove-waitlist').on('click', function() {
                const entryId = $(this).data('entry-id');
                removeFromWaitlist(entryId);
            });

            // Notify student
            $('.notify-student').on('click', function() {
                const email = $(this).data('student-email');
                notifyStudent(email);
            });

            function enrollFromWaitlist(studentId, courseId, semesterId, button) {
                button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');

                const request = {
                    studentId: studentId,
                    courseId: courseId,
                    semesterId: semesterId,
                    requestedBy: 'Waitlist Management'  // ADDED: Required field
                };

                // Use API endpoint
                $.post('/api/EnrollmentApi/enroll', request)  // CHANGED
                    .done(function(result) {
                        if (result.success) {
                            showToast('Success', 'Student enrolled successfully!', 'success');
                            // Remove the row from table
                            button.closest('tr').fadeOut(300, function() {
                                $(this).remove();
                                updateWaitlistCount();
                            });
                        } else {
                            showToast('Error', result.errors ? result.errors.join(', ') : 'Enrollment failed', 'error');
                            button.prop('disabled', false).html('<i class="fas fa-user-plus"></i>');
                        }
                    })
                    .fail(function(xhr, status, error) {
                        showToast('Error', 'Failed to enroll student: ' + error, 'error');
                        button.prop('disabled', false).html('<i class="fas fa-user-plus"></i>');
                    });
            }

            function removeFromWaitlist(entryId) {
                if (!confirm('Are you sure you want to remove this student from the waitlist?')) return;

                // This should use MVC controller since it's a view operation
                $.post('@Url.Action("RemoveFromWaitlist", "Enrollment")', { entryId: entryId })
                    .done(function(result) {
                        if (result.success) {
                            showToast('Success', 'Student removed from waitlist', 'success');
                            $(`[data-entry-id="${entryId}"]`).fadeOut(300, function() {
                                $(this).remove();
                                updateWaitlistCount();
                            });
                        } else {
                            showToast('Error', result.message, 'error');
                        }
                    })
                    .fail(function() {
                        showToast('Error', 'Failed to remove from waitlist', 'error');
                    });
            }

            function notifyStudent(email) {
                // Implement email notification logic
                showToast('Info', `Notification would be sent to ${email}`, 'info');
            }

            function loadSemesters() {
                // Use MVC endpoint for dropdown data
                $.get('@Url.Action("GetActiveSemesters", "Enrollment")')
                    .done(function(semesters) {
                        const select = $('#semesterFilter');
                        semesters.forEach(semester => {
                            select.append(`<option value="${semester.id}">${semester.name}</option>`);
                        });
                    });
            }

            function loadCourses() {
                // Use MVC endpoint for dropdown data
                $.get('@Url.Action("GetCoursesWithWaitlists", "Enrollment")')
                    .done(function(courses) {
                        const select = $('#courseFilter');
                        courses.forEach(course => {
                            select.append(`<option value="${course.id}">${course.courseCode} - ${course.courseName}</option>`);
                        });
                    });
            }

            function updateWaitlistCount() {
                const count = $('#waitlistTable tbody tr').length;
                $('#waitlistCount').text(count + ' entries');
            }

            function showToast(title, message, type) {
                const toastClass = type === 'success' ? 'alert-success' :
                                 type === 'error' ? 'alert-danger' : 'alert-info';

                const toast = document.createElement('div');
                toast.className = `alert ${toastClass} alert-dismissible fade show alert-toast`;
                toast.style.position = 'fixed';
                toast.style.top = '20px';
                toast.style.right = '20px';
                toast.style.zIndex = '1060';
                toast.style.minWidth = '300px';
                toast.innerHTML = `
                    <strong>${title}</strong> ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.body.appendChild(toast);

                setTimeout(() => {
                    toast.remove();
                }, 5000);
            }
        });
    </script>
}
