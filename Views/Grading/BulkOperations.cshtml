@model StudentManagementSystem.Controllers.BulkOperationsViewModel
@{
    ViewData["Title"] = "Bulk Grading Operations";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="display-4">Bulk Grading Operations</h1>
            <partial name="_AlertMessages" />
        </div>
    </div>

    <div class="row">
        <!-- Bulk Grade Upload -->
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-success text-white">
                    <h5><i class="fas fa-file-upload me-2"></i>Bulk Grade Upload</h5>
                </div>
                <div class="card-body">
                    <form method="post" asp-action="BulkUploadGrades" enctype="multipart/form-data" id="uploadForm">
                        <div class="mb-3">
                            <label class="form-label">Select Course</label>
                            <select name="courseId" class="form-select" required id="uploadCourse">
                                <option value="">-- Select Course --</option>
                                @foreach (var course in Model.Courses)
                                {
                                    <option value="@course.Id">@course.CourseCode - @course.CourseName</option>
                                }
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Select Semester</label>
                            <select name="semesterId" class="form-select" required id="uploadSemester">
                                <option value="">-- Select Semester --</option>
                                @foreach (var semester in Model.Semesters)
                                {
                                    <option value="@semester.Id">@semester.Name</option>
                                }
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Excel File</label>
                            <input type="file" class="form-control" name="file" accept=".xlsx,.xls,.csv" required id="uploadFile" />
                            <div class="form-text">
                                Supported formats: .xlsx, .xls, .csv. File should follow the template format.
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="overwriteExisting" value="true" id="overwriteCheck" />
                                <label class="form-check-label" for="overwriteCheck">
                                    Overwrite existing grades
                                </label>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success w-100" id="uploadBtn">
                            <i class="fas fa-upload me-1"></i> Upload Grades
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Bulk Final Grade Calculation -->
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h5><i class="fas fa-calculator me-2"></i>Bulk Final Grade Calculation</h5>
                </div>
                <div class="card-body">
                    <form method="post" asp-action="BulkCalculateFinalGrades" id="calculateForm">
                        <div class="mb-3">
                            <label class="form-label">Select Course</label>
                            <select name="courseId" class="form-select" required id="calculateCourse">
                                <option value="">-- Select Course --</option>
                                @foreach (var course in Model.Courses)
                                {
                                    <option value="@course.Id">@course.CourseCode - @course.CourseName</option>
                                }
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Select Semester</label>
                            <select name="semesterId" class="form-select" required id="calculateSemester">
                                <option value="">-- Select Semester --</option>
                                @foreach (var semester in Model.Semesters)
                                {
                                    <option value="@semester.Id">@semester.Name</option>
                                }
                            </select>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="recalculateAll" value="true" id="recalculateCheck" />
                                <label class="form-check-label" for="recalculateCheck">
                                    Recalculate all students (including previously calculated)
                                </label>
                            </div>
                        </div>
                        <div class="alert alert-info">
                            <small>
                                <i class="fas fa-info-circle me-1"></i>
                                This will calculate final grades for all students in the selected course and semester based on their component grades.
                            </small>
                        </div>
                        <button type="submit" class="btn btn-primary w-100" id="calculateBtn">
                            <i class="fas fa-calculator me-1"></i> Calculate All Final Grades
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Template Downloads -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5><i class="fas fa-download me-2"></i>Template Downloads</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Grades Template -->
                        <div class="col-md-4 mb-3">
                            <div class="card template-card h-100 text-center">
                                <div class="card-body">
                                    <i class="fas fa-file-excel fa-3x text-success mb-3"></i>
                                    <h6>Grade Upload Template</h6>
                                    <p class="text-muted small">
                                        Template for bulk grade entry with student IDs, component names, and marks.
                                    </p>
                                    <div class="mt-3">
                                        <a href="@Url.Action("DownloadTemplate", new { type = "grades" })"
                                           class="btn btn-outline-success btn-sm me-2">
                                            <i class="fas fa-download me-1"></i>Excel
                                        </a>
                                        <button class="btn btn-outline-info btn-sm" onclick="showFormatHelp('grades')">
                                            <i class="fas fa-info-circle me-1"></i>Format
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Roster Template -->
                        <div class="col-md-4 mb-3">
                            <div class="card template-card h-100 text-center">
                                <div class="card-body">
                                    <i class="fas fa-users fa-3x text-info mb-3"></i>
                                    <h6>Student Roster Template</h6>
                                    <p class="text-muted small">
                                        Template for importing student lists with personal and academic information.
                                    </p>
                                    <div class="mt-3">
                                        <a href="@Url.Action("DownloadTemplate", new { type = "roster" })"
                                           class="btn btn-outline-info btn-sm me-2">
                                            <i class="fas fa-download me-1"></i>Excel
                                        </a>
                                        <button class="btn btn-outline-info btn-sm" onclick="showFormatHelp('roster')">
                                            <i class="fas fa-info-circle me-1"></i>Format
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Export Template -->
                        <div class="col-md-4 mb-3">
                            <div class="card template-card h-100 text-center">
                                <div class="card-body">
                                    <i class="fas fa-file-export fa-3x text-primary mb-3"></i>
                                    <h6>Export Configuration Template</h6>
                                    <p class="text-muted small">
                                        Template for configuring data export settings and formats.
                                    </p>
                                    <div class="mt-3">
                                        <a href="@Url.Action("DownloadTemplate", new { type = "export" })"
                                           class="btn btn-outline-primary btn-sm me-2">
                                            <i class="fas fa-download me-1"></i>Excel
                                        </a>
                                        <button class="btn btn-outline-info btn-sm" onclick="showFormatHelp('export')">
                                            <i class="fas fa-info-circle me-1"></i>Format
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-bar me-2"></i>Quick Statistics</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="stat-card">
                                <h3 class="text-primary" id="totalCourses">@Model.Courses.Count</h3>
                                <small class="text-muted">Active Courses</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <h3 class="text-success" id="totalSemesters">@Model.Semesters.Count</h3>
                                <small class="text-muted">Active Semesters</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <h3 class="text-info" id="recentUploads">0</h3>
                                <small class="text-muted">Recent Uploads</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <h3 class="text-warning" id="pendingCalculations">0</h3>
                                <small class="text-muted">Pending Calculations</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-history me-2"></i>Recent Bulk Operations</h5>
                    <button class="btn btn-sm btn-outline-secondary" onclick="refreshActivity()">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="card-body">
                    <div id="activityList" class="activity-list">
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-clock fa-2x mb-2"></i>
                            <p>No recent bulk operations</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Format Help Modal -->
<div class="modal fade" id="formatHelpModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="formatHelpTitle">Template Format</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="formatHelpContent">
                <!-- Content will be populated by JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            initializeFormHandlers();
            loadQuickStats();
        });

        function initializeFormHandlers() {
            // Upload form validation
            const uploadForm = document.getElementById('uploadForm');
            if (uploadForm) {
                uploadForm.addEventListener('submit', function(e) {
                    const fileInput = document.getElementById('uploadFile');
                    const courseSelect = document.getElementById('uploadCourse');
                    const semesterSelect = document.getElementById('uploadSemester');

                    if (!fileInput.files.length || !courseSelect.value || !semesterSelect.value) {
                        e.preventDefault();
                        alert('Please fill all required fields before uploading.');
                        return;
                    }

                    // Show loading state
                    const uploadBtn = document.getElementById('uploadBtn');
                    uploadBtn.disabled = true;
                    uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Uploading...';
                });
            }

            // Calculate form validation
            const calculateForm = document.getElementById('calculateForm');
            if (calculateForm) {
                calculateForm.addEventListener('submit', function(e) {
                    const courseSelect = document.getElementById('calculateCourse');
                    const semesterSelect = document.getElementById('calculateSemester');

                    if (!courseSelect.value || !semesterSelect.value) {
                        e.preventDefault();
                        alert('Please select both course and semester.');
                        return;
                    }

                    if (!confirm('This will calculate final grades for all students in the selected course. Continue?')) {
                        e.preventDefault();
                        return;
                    }

                    // Show loading state
                    const calculateBtn = document.getElementById('calculateBtn');
                    calculateBtn.disabled = true;
                    calculateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Calculating...';
                });
            }
        }

        function showFormatHelp(templateType) {
            const modal = new bootstrap.Modal(document.getElementById('formatHelpModal'));
            const title = document.getElementById('formatHelpTitle');
            const content = document.getElementById('formatHelpContent');

            let formatInfo = '';

            switch (templateType) {
                case 'grades':
                    title.textContent = 'Grade Upload Template Format';
                    formatInfo = `
                        <h6>Required Columns:</h6>
                        <ul>
                            <li><strong>StudentID</strong> - Unique student identifier</li>
                            <li><strong>StudentName</strong> - Full student name</li>
                            <li><strong>CourseCode</strong> - Course code (e.g., CS101)</li>
                            <li><strong>Component</strong> - Grading component name</li>
                            <li><strong>MarksObtained</strong> - Numeric marks (0-100)</li>
                            <li><strong>IsAbsent</strong> - TRUE/FALSE for absent status</li>
                            <li><strong>IsExempted</strong> - TRUE/FALSE for exemption</li>
                            <li><strong>Remarks</strong> - Optional comments</li>
                        </ul>
                        <h6>Example Data:</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead>
                                    <tr>
                                        <th>StudentID</th>
                                        <th>StudentName</th>
                                        <th>CourseCode</th>
                                        <th>Component</th>
                                        <th>MarksObtained</th>
                                        <th>IsAbsent</th>
                                        <th>IsExempted</th>
                                        <th>Remarks</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>STU001</td>
                                        <td>John Doe</td>
                                        <td>CS101</td>
                                        <td>Final Exam</td>
                                        <td>85</td>
                                        <td>FALSE</td>
                                        <td>FALSE</td>
                                        <td>Excellent work</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    `;
                    break;

                case 'roster':
                    title.textContent = 'Student Roster Template Format';
                    formatInfo = `
                        <h6>Required Columns:</h6>
                        <ul>
                            <li><strong>StudentID</strong> - Unique student identifier</li>
                            <li><strong>FullName</strong> - Student's full name</li>
                            <li><strong>Email</strong> - Email address</li>
                            <li><strong>Phone</strong> - Contact number</li>
                            <li><strong>Department</strong> - Department name</li>
                            <li><strong>GradeLevel</strong> - Academic level (1-12)</li>
                            <li><strong>GPA</strong> - Current GPA</li>
                        </ul>
                    `;
                    break;

                case 'export':
                    title.textContent = 'Export Configuration Template Format';
                    formatInfo = `
                        <h6>Configuration Options:</h6>
                        <ul>
                            <li><strong>ExportType</strong> - Type of data to export</li>
                            <li><strong>CourseCode</strong> - Specific course code</li>
                            <li><strong>Semester</strong> - Academic semester</li>
                            <li><strong>IncludeComponents</strong> - Include grading components</li>
                            <li><strong>IncludeStudentDetails</strong> - Include student information</li>
                            <li><strong>Format</strong> - Output format (Excel/CSV/PDF)</li>
                        </ul>
                    `;
                    break;
            }

            content.innerHTML = formatInfo;
            modal.show();
        }

        function loadQuickStats() {
            // Simulate loading statistics
            // In a real application, you would fetch this data from your API
            setTimeout(() => {
                document.getElementById('recentUploads').textContent = '12';
                document.getElementById('pendingCalculations').textContent = '3';
            }, 1000);
        }

        function refreshActivity() {
            const activityList = document.getElementById('activityList');
            activityList.innerHTML = `
                <div class="text-center py-2">
                    <i class="fas fa-spinner fa-spin me-2"></i>Loading...
                </div>
            `;

            // Simulate API call
            setTimeout(() => {
                activityList.innerHTML = `
                    <div class="activity-item border-bottom py-2">
                        <div class="d-flex justify-content-between">
                            <span><i class="fas fa-upload text-success me-2"></i>Grade upload for CS101</span>
                            <small class="text-muted">2 minutes ago</small>
                        </div>
                        <small class="text-muted">45 records processed</small>
                    </div>
                    <div class="activity-item border-bottom py-2">
                        <div class="d-flex justify-content-between">
                            <span><i class="fas fa-calculator text-primary me-2"></i>Final grade calculation for MATH201</span>
                            <small class="text-muted">1 hour ago</small>
                        </div>
                        <small class="text-muted">32 students processed</small>
                    </div>
                    <div class="activity-item py-2">
                        <div class="d-flex justify-content-between">
                            <span><i class="fas fa-download text-info me-2"></i>Template download</span>
                            <small class="text-muted">3 hours ago</small>
                        </div>
                        <small class="text-muted">Grade upload template</small>
                    </div>
                `;
            }, 1500);
        }

        // Auto-refresh activity every 30 seconds
        setInterval(refreshActivity, 30000);
    </script>

    <style>
        .template-card {
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

            .template-card:hover {
                transform: translateY(-5px);
                border-color: #0d6efd;
                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            }

        .stat-card {
            padding: 1rem;
        }

            .stat-card h3 {
                margin-bottom: 0.5rem;
                font-weight: 700;
            }

        .activity-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .activity-item {
            transition: background-color 0.2s ease;
        }

            .activity-item:hover {
                background-color: #f8f9fa;
            }

        .btn-loading {
            position: relative;
        }

            .btn-loading .fa-spinner {
                position: relative;
                z-index: 1;
            }
    </style>
}