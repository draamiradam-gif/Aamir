@model StudentManagementSystem.Models.Semester
@{
    ViewData["Title"] = "Semester Details";
    var courses = ViewBag.Courses as List<StudentManagementSystem.Models.Course> ?? new List<StudentManagementSystem.Models.Course>();
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>
            <i class="fas fa-calendar-alt me-2"></i>@Model.Name - Details
        </h2>
        <div>
            <a href="@Url.Action("Index")" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-1"></i>Back to List
            </a>
            <a href="@Url.Action("Edit", new { id = Model.Id })" class="btn btn-warning">
                <i class="fas fa-edit me-1"></i>Edit Semester
            </a>
        </div>
    </div>

    <!-- Semester Information Card -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
                <i class="fas fa-info-circle me-2"></i>Semester Information
            </h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <table class="table table-borderless">
                        <tr>
                            <td><strong>Name:</strong></td>
                            <td>@Model.Name</td>
                        </tr>
                        <tr>
                            <td><strong>Type:</strong></td>
                            <td>@Model.SemesterType</td>
                        </tr>
                        <tr>
                            <td><strong>Academic Year:</strong></td>
                            <td>@Model.AcademicYear</td>
                        </tr>
                        <tr>
                            <td><strong>Start Date:</strong></td>
                            <td>@Model.StartDate.ToString("MMM dd, yyyy")</td>
                        </tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <table class="table table-borderless">
                        <tr>
                            <td><strong>End Date:</strong></td>
                            <td>@Model.EndDate.ToString("MMM dd, yyyy")</td>
                        </tr>
                        <tr>
                            <td><strong>Registration Period:</strong></td>
                            <td>@Model.RegistrationStartDate.ToString("MMM dd") - @Model.RegistrationEndDate.ToString("MMM dd, yyyy")</td>
                        </tr>
                        <tr>
                            <td><strong>Status:</strong></td>
                            <td>
                                @if (Model.IsActive)
                                {
                                    <span class="badge bg-success">Active</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">Inactive</span>
                                }
                                @if (Model.IsCurrent)
                                {
                                    <span class="badge bg-primary ms-1">Current</span>
                                }
                                @if (Model.IsRegistrationOpen)
                                {
                                    <span class="badge bg-warning ms-1">Registration Open</span>
                                }
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Full Path:</strong></td>
                            <td>@Model.FullPath</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Courses Management Card -->
    <div class="card">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-book me-2"></i>Course Management
                <span class="badge bg-primary ms-2">@courses.Count Courses</span>
            </h5>
            <div class="btn-group">
                <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addCoursesModal">
                    <i class="fas fa-plus me-1"></i>Add Courses
                </button>
                <button class="btn btn-danger btn-sm" id="removeSelectedCoursesBtn" style="display: none;">
                    <i class="fas fa-trash me-1"></i>Remove Selected
                </button>
                <button class="btn btn-outline-danger btn-sm" id="removeAllCoursesBtn" @(courses.Count == 0 ? "disabled" : "")>
                    <i class="fas fa-broom me-1"></i>Remove All
                </button>
                <button class="btn btn-primary btn-sm" id="bulkEnrollBtn" @(courses.Count == 0 ? "disabled" : "")>
                    <i class="fas fa-user-plus me-1"></i>Bulk Enroll
                </button>
            </div>
        </div>

        <div class="card-body p-0">
            @if (courses.Any())
            {
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0" id="coursesTable">
                        <thead class="table-light">
                            <tr>
                                <th width="50">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="selectAllCourses">
                                    </div>
                                </th>
                                <th>Course Code</th>
                                <th>Course Name</th>
                                <th>Credits</th>
                                <th>Department</th>
                                <th>Available Seats</th>
                                <th>Prerequisites</th>
                                <th>Status</th>
                                <th width="200" class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var course in courses)
                            {
                                <tr>
                                    <td>
                                        <div class="form-check">
                                            <input class="form-check-input course-checkbox" type="checkbox" value="@course.Id" data-course-name="@course.CourseName">
                                        </div>
                                    </td>
                                    <td class="fw-bold">@course.CourseCode</td>
                                    <td>@course.CourseName</td>
                                    <td class="text-center">
                                        <span class="badge bg-info">@course.Credits</span>
                                    </td>
                                    <td>@course.Department</td>
                                    <td class="text-center">
                                        @{
                                            var availableSeats = course.MaxStudents - course.CurrentEnrollment;
                                            var percentage = course.MaxStudents > 0 ? (course.CurrentEnrollment * 100.0) / course.MaxStudents : 0;
                                        }
                                        <div class="progress mb-1" style="height: 6px;">
                                            <div class="progress-bar @(percentage >= 90 ? "bg-danger" : percentage >= 70 ? "bg-warning" : "bg-success")"
                                                 style="width: @percentage%" title="@percentage% Full">
                                            </div>
                                        </div>
                                        <small>@availableSeats/@course.MaxStudents available</small>
                                    </td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(course.PrerequisitesString))
                                        {
                                            <span class="badge bg-secondary" data-bs-toggle="tooltip" title="@course.PrerequisitesString">
                                                @(course.PrerequisitesString.Length > 20 ? course.PrerequisitesString.Substring(0, 20) + "..." : course.PrerequisitesString)
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">None</span>
                                        }
                                    </td>
                                    <td>
                                        @if (course.IsActive)
                                        {
                                            <span class="badge bg-success">Active</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary">Inactive</span>
                                        }
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button class="btn btn-outline-primary enroll-single-btn"
                                                    data-course-id="@course.Id"
                                                    data-course-name="@course.CourseName"
                                                    title="Enroll Students">
                                                <i class="fas fa-user-plus"></i>
                                            </button>
                                            <a href="@Url.Action("Edit", "Courses", new { id = course.Id })"
                                               class="btn btn-outline-warning" title="Edit Course">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <button class="btn btn-outline-danger remove-course-btn"
                                                    data-course-id="@course.Id"
                                                    data-course-name="@course.CourseName"
                                                    title="Remove from Semester">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center py-5">
                    <i class="fas fa-book-open fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted">No Courses Assigned</h4>
                    <p class="text-muted">This semester doesn't have any courses assigned yet.</p>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCoursesModal">
                        <i class="fas fa-plus me-1"></i>Add Courses to Semester
                    </button>
                </div>
            }
        </div>
    </div>
</div>

<!-- Add Courses Modal -->
<div class="modal fade" id="addCoursesModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>Add Courses to Semester
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <input type="text" class="form-control" id="courseSearch" placeholder="Search courses...">
                    </div>
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="selectAllAvailable">
                            <label class="form-check-label" for="selectAllAvailable">Select All</label>
                        </div>
                    </div>
                </div>
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-sm table-hover" id="availableCoursesTable">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th width="50">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="selectAllAvailableCourses">
                                    </div>
                                </th>
                                <th>Course Code</th>
                                <th>Course Name</th>
                                <th>Credits</th>
                                <th>Department</th>
                                <th>Current Semester</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirmAddCourses">Add Selected Courses</button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Enrollment Modal -->
<div class="modal fade" id="bulkEnrollModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-users me-2"></i>Bulk Student Enrollment
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="bulkEnrollContent">
                    <p>Enroll students in <strong id="selectedCoursesCount">0</strong> selected courses from semester <strong>@Model.Name</strong>.</p>

                    <div class="mb-3">
                        <label class="form-label">Select Students:</label>
                        <select class="form-select" id="studentGroupSelect" multiple size="6">
                            <option value="all">All Students in Department</option>
                            <option value="eligible">Only Eligible Students</option>
                            <!-- Will be populated by JavaScript -->
                        </select>
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Students will be enrolled only in courses where they meet all requirements (prerequisites, GPA, passed hours, capacity).
                    </div>

                    <div id="enrollmentPreview" style="display: none;">
                        <h6>Enrollment Preview:</h6>
                        <div id="previewContent" class="small text-muted"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmBulkEnroll">Start Bulk Enrollment</button>
            </div>
        </div>
    </div>
</div>

<!-- Remove Confirmation Modal -->
<div class="modal fade" id="removeConfirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>Confirm Removal
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="removeSingleContent">
                    <p>Are you sure you want to remove <strong id="removeCourseName"></strong> from this semester?</p>
                    <p class="text-muted small">The course will remain in the system but will no longer be associated with this semester.</p>
                </div>
                <div id="removeMultipleContent" style="display: none;">
                    <p>Are you sure you want to remove <strong id="removeCount">0</strong> selected courses from this semester?</p>
                    <div id="removeCourseList" class="small text-muted mt-2"></div>
                </div>
                <div id="removeAllContent" style="display: none;">
                    <div class="alert alert-warning">
                        <h6><i class="fas fa-radiation me-2"></i>Warning</h6>
                        <p class="mb-0">You are about to remove <strong>ALL @courses.Count courses</strong> from this semester!</p>
                    </div>
                    <p class="text-danger">
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        This will disassociate all courses from the semester. Courses will remain in the system.
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmRemoveBtn">Remove</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize tooltips
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            const tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });

            // Course selection functionality
            const selectAllCourses = document.getElementById('selectAllCourses');
            const courseCheckboxes = document.querySelectorAll('.course-checkbox');
            const removeSelectedBtn = document.getElementById('removeSelectedCoursesBtn');
            const removeAllBtn = document.getElementById('removeAllCoursesBtn');
            const bulkEnrollBtn = document.getElementById('bulkEnrollBtn');

            const removeModal = new bootstrap.Modal(document.getElementById('removeConfirmModal'));
            const bulkEnrollModal = new bootstrap.Modal(document.getElementById('bulkEnrollModal'));
            const addCoursesModal = new bootstrap.Modal(document.getElementById('addCoursesModal'));

            let currentRemoveAction = '';
            let selectedCourseIds = [];
            let selectedStudentIds = [];

            function updateCourseSelectionUI() {
                const selectedCount = document.querySelectorAll('.course-checkbox:checked').length;

                if (selectedCount > 0) {
                    removeSelectedBtn.style.display = 'inline-block';
                    removeSelectedBtn.innerHTML = `<i class="fas fa-trash me-1"></i>Remove Selected (${selectedCount})`;
                    bulkEnrollBtn.disabled = false;
                } else {
                    removeSelectedBtn.style.display = 'none';
                    bulkEnrollBtn.disabled = true;
                }

                selectedCourseIds = Array.from(document.querySelectorAll('.course-checkbox:checked'))
                    .map(cb => parseInt(cb.value));
            }

            // Select all courses
            selectAllCourses?.addEventListener('change', function() {
                courseCheckboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                });
                updateCourseSelectionUI();
            });

            courseCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', updateCourseSelectionUI);
            });

            // Remove selected courses
            removeSelectedBtn?.addEventListener('click', function() {
                if (selectedCourseIds.length > 0) {
                    showRemoveConfirmation('multiple', selectedCourseIds);
                }
            });

            // Remove all courses
            removeAllBtn?.addEventListener('click', function() {
                showRemoveConfirmation('all');
            });

            // Single course remove
            document.querySelectorAll('.remove-course-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const courseId = parseInt(this.dataset.courseId);
                    const courseName = this.dataset.courseName;
                    showRemoveConfirmation('single', [courseId], courseName);
                });
            });

            // Bulk enrollment
                    // In Semester Details JavaScript - REPLACE THE BULK ENROLLMENT SECTION

        // Bulk enrollment
        bulkEnrollBtn?.addEventListener('click', function() {
            if (selectedCourseIds.length > 0) {
                showBulkEnrollmentModal();
            } else {
                alert('Please select at least one course to enroll students in.');
            }
        });

        function showBulkEnrollmentModal() {
            console.log('Showing bulk enrollment modal for courses:', selectedCourseIds);
            document.getElementById('selectedCoursesCount').textContent = selectedCourseIds.length;

            // Clear previous students
            const select = document.getElementById('studentGroupSelect');
            select.innerHTML = '<option value="">Loading students...</option>';

            // Load student options
            loadStudentsForBulkEnrollment();
            bulkEnrollModal.show();
        }

        function loadStudentsForBulkEnrollment() {
            console.log('Loading students for semester:', @Model.Id);

            fetch('@Url.Action("GetStudentEnrollmentOptions", "Semesters")?semesterId=@Model.Id')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(students => {
                    console.log('Loaded students:', students);
                    const select = document.getElementById('studentGroupSelect');
                    select.innerHTML = '';

                    if (students && students.length > 0) {
                        students.forEach(student => {
                            const option = document.createElement('option');
                            option.value = student.id;
                            option.textContent = `${student.name} (${student.code}) - GPA: ${student.gpa}`;
                            select.appendChild(option);
                        });

                        // Enable multi-select
                        select.multiple = true;
                        select.size = Math.min(8, students.length + 2);
                    } else {
                        const option = document.createElement('option');
                        option.value = "";
                        option.textContent = "No students found for this semester";
                        option.disabled = true;
                        select.appendChild(option);
                    }
                })
                .catch(error => {
                    console.error('Error loading students:', error);
                    const select = document.getElementById('studentGroupSelect');
                    select.innerHTML = '<option value="">Error loading students</option>';
                });
        }

        // Bulk enrollment confirmation
        document.getElementById('confirmBulkEnroll')?.addEventListener('click', function() {
            const select = document.getElementById('studentGroupSelect');
            const selectedOptions = Array.from(select.selectedOptions);
            const selectedStudentIds = selectedOptions
                .map(option => parseInt(option.value))
                .filter(id => !isNaN(id) && id > 0);

            console.log('Selected student IDs:', selectedStudentIds);
            console.log('Selected course IDs:', selectedCourseIds);

            if (selectedStudentIds.length === 0) {
                alert('Please select at least one student.');
                return;
            }

            if (selectedCourseIds.length === 0) {
                alert('Please select at least one course.');
                return;
            }

            // Show loading state
            const originalText = this.innerHTML;
            this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Processing...';
            this.disabled = true;

            // Create request data
            const requestData = {
                semesterId: @Model.Id,
                courseIds: selectedCourseIds,
                studentIds: selectedStudentIds
            };

            console.log('Sending bulk enrollment request:', requestData);

            fetch('@Url.Action("BulkEnrollStudents", "Semesters")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                },
                body: JSON.stringify(requestData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                console.log('Bulk enrollment response:', data);
                if (data.success) {
                    showToast('Success!', data.message, 'success');
                    bulkEnrollModal.hide();
                    // Optional: Refresh the page after success
                    setTimeout(() => location.reload(), 2000);
                } else {
                    showToast('Error', data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error during bulk enrollment:', error);
                showToast('Error', 'An error occurred during bulk enrollment: ' + error.message, 'error');
            })
            .finally(() => {
                this.innerHTML = originalText;
                this.disabled = false;
            });
        });

            function showRemoveConfirmation(action, courseIds = [], courseName = '') {
                currentRemoveAction = action;

                // Reset modal content
                document.getElementById('removeSingleContent').style.display = 'none';
                document.getElementById('removeMultipleContent').style.display = 'none';
                document.getElementById('removeAllContent').style.display = 'none';

                if (action === 'single') {
                    document.getElementById('removeSingleContent').style.display = 'block';
                    document.getElementById('removeCourseName').textContent = courseName;
                } else if (action === 'multiple') {
                    document.getElementById('removeMultipleContent').style.display = 'block';
                    document.getElementById('removeCount').textContent = courseIds.length;

                    const courseList = document.getElementById('removeCourseList');
                    courseList.innerHTML = '';
                    courseIds.forEach(id => {
                        const checkbox = document.querySelector(`.course-checkbox[value="${id}"]`);
                        if (checkbox) {
                            const courseName = checkbox.dataset.courseName;
                            const div = document.createElement('div');
                            div.className = 'border-bottom pb-1 mb-1';
                            div.textContent = courseName;
                            courseList.appendChild(div);
                        }
                    });
                } else if (action === 'all') {
                    document.getElementById('removeAllContent').style.display = 'block';
                }

                removeModal.show();
            }

            // Confirm remove action
            document.getElementById('confirmRemoveBtn')?.addEventListener('click', function() {
                if (currentRemoveAction === 'single' || currentRemoveAction === 'multiple') {
                    removeCoursesFromSemester(selectedCourseIds);
                } else if (currentRemoveAction === 'all') {
                    removeAllCoursesFromSemester();
                }
            });

            function removeCoursesFromSemester(courseIds) {
                fetch('@Url.Action("RemoveCoursesFromSemester", "Semesters")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    body: JSON.stringify({
                        semesterId: @Model.Id,
                        courseIds: courseIds
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('Success!', data.message, 'success');
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        showToast('Error', data.message, 'error');
                    }
                    removeModal.hide();
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('Error', 'An error occurred while removing courses.', 'error');
                    removeModal.hide();
                });
            }

            function removeAllCoursesFromSemester() {
                fetch('@Url.Action("RemoveAllCoursesFromSemester", "Semesters")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    body: JSON.stringify(@Model.Id)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('Success!', data.message, 'success');
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        showToast('Error', data.message, 'error');
                    }
                    removeModal.hide();
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('Error', 'An error occurred while removing all courses.', 'error');
                    removeModal.hide();
                });
            }

            // Load available courses for adding
            function loadAvailableCourses() {
                fetch('@Url.Action("GetAvailableCourses", "Semesters")?semesterId=@Model.Id')
                    .then(response => response.json())
                    .then(courses => {
                        const tbody = document.getElementById('availableCoursesTable').querySelector('tbody');
                        tbody.innerHTML = '';

                        courses.forEach(course => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>
                                    <div class="form-check">
                                        <input class="form-check-input available-course-checkbox" type="checkbox" value="${course.id}">
                                    </div>
                                </td>
                                <td>${course.courseCode}</td>
                                <td>${course.courseName}</td>
                                <td>${course.credits}</td>
                                <td>${course.department}</td>
                                <td>${course.currentSemester}</td>
                                <td>
                                    <span class="badge ${course.isActive ? 'bg-success' : 'bg-secondary'}">
                                        ${course.isActive ? 'Active' : 'Inactive'}
                                    </span>
                                </td>
                            `;
                            tbody.appendChild(row);
                        });
                    })
                    .catch(error => {
                        console.error('Error loading available courses:', error);
                    });
            }

            // Initialize when add courses modal is shown
            document.getElementById('addCoursesModal')?.addEventListener('show.bs.modal', loadAvailableCourses);

            // Add selected courses to semester
            document.getElementById('confirmAddCourses')?.addEventListener('click', function() {
                const selectedCourseIds = Array.from(document.querySelectorAll('.available-course-checkbox:checked'))
                    .map(cb => parseInt(cb.value));

                if (selectedCourseIds.length === 0) {
                    alert('Please select at least one course to add.');
                    return;
                }

                fetch('@Url.Action("AddCoursesToSemester", "Semesters")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    body: JSON.stringify({
                        semesterId: @Model.Id,
                        courseIds: selectedCourseIds
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('Success!', data.message, 'success');
                        addCoursesModal.hide();
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        showToast('Error', data.message, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('Error', 'An error occurred while adding courses.', 'error');
                });
            });

            // Bulk enrollment functionality
            function showBulkEnrollmentModal() {
                document.getElementById('selectedCoursesCount').textContent = selectedCourseIds.length;

                // Load student options
                fetch('@Url.Action("GetStudentEnrollmentOptions", "Semesters")?semesterId=@Model.Id')
                    .then(response => response.json())
                    .then(students => {
                        const select = document.getElementById('studentGroupSelect');
                        select.innerHTML = '';

                        students.forEach(student => {
                            const option = document.createElement('option');
                            option.value = student.id;
                            option.textContent = `${student.name} (${student.code}) - GPA: ${student.gpa}`;
                            select.appendChild(option);
                        });

                        // Enable multi-select
                        select.multiple = true;
                        select.size = 6;
                    })
                    .catch(error => {
                        console.error('Error loading students:', error);
                    });

                bulkEnrollModal.show();
            }

            // Bulk enrollment confirmation
            document.getElementById('confirmBulkEnroll')?.addEventListener('click', function() {
                const select = document.getElementById('studentGroupSelect');
                const selectedStudentIds = Array.from(select.selectedOptions)
                    .map(option => parseInt(option.value))
                    .filter(id => !isNaN(id));

                if (selectedStudentIds.length === 0) {
                    alert('Please select at least one student.');
                    return;
                }

                // Show loading state
                this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Processing...';
                this.disabled = true;

                fetch('@Url.Action("BulkEnrollStudents", "Semesters")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    body: JSON.stringify({
                        semesterId: @Model.Id,
                        courseIds: selectedCourseIds,
                        studentIds: selectedStudentIds
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('Success!', data.message, 'success');
                        bulkEnrollModal.hide();
                    } else {
                        showToast('Error', data.message, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('Error', 'An error occurred during bulk enrollment', 'error');
                })
                .finally(() => {
                    this.innerHTML = '<i class="fas fa-user-plus me-1"></i>Start Bulk Enrollment';
                    this.disabled = false;
                });
            });

            function showToast(title, message, type) {
                // Remove existing toasts
                document.querySelectorAll('.alert-toast').forEach(toast => toast.remove());

                const toast = document.createElement('div');
                toast.className = `alert alert-${type} alert-dismissible fade show alert-toast`;
                toast.style.position = 'fixed';
                toast.style.top = '20px';
                toast.style.right = '20px';
                toast.style.zIndex = '1060';
                toast.style.minWidth = '300px';
                toast.innerHTML = `
                    <strong>${title}</strong> ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.body.appendChild(toast);

                setTimeout(() => {
                    toast.remove();
                }, 5000);
            }

            // Initialize
            updateCourseSelectionUI();
        });
    </script>
}