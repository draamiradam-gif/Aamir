@model StudentManagementSystem.Models.ViewModels.CreateUserViewModel
@{
    ViewData["Title"] = "Create User";
    var roles = ViewBag.Roles as List<Microsoft.AspNetCore.Identity.IdentityRole> ?? new List<Microsoft.AspNetCore.Identity.IdentityRole>();
    
    // Get grouped permissions using the helper method
    var permissionGroups = PermissionHelper.GetGroupedPermissions(new List<PermissionModule>());
}

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h3 mb-0">
                <i class="fas fa-user-plus me-2"></i>@ViewData["Title"]
            </h1>
            <p class="text-muted">Create a new system user</p>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card-modern">
                <div class="card-header">
                    <h5 class="mb-0">User Information</h5>
                </div>
                <div class="card-body">
                    <form asp-action="Create" method="post" id="createUserForm">
                        @Html.AntiForgeryToken()
                        <div asp-validation-summary="ModelOnly" class="text-danger"></div>

                        <!-- Email and Password -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label asp-for="Email" class="form-label fw-bold"></label>
                                    <input asp-for="Email" class="form-control" placeholder="Enter email address" />
                                    <span asp-validation-for="Email" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label asp-for="Password" class="form-label fw-bold"></label>
                                    <input asp-for="Password" type="password" class="form-control"
                                           placeholder="Enter password" id="passwordField" />
                                    <span asp-validation-for="Password" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Confirm Password -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label asp-for="ConfirmPassword" class="form-label fw-bold"></label>
                                    <input asp-for="ConfirmPassword" type="password" class="form-control"
                                           placeholder="Confirm password" />
                                    <span asp-validation-for="ConfirmPassword" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Template Selection -->
                        <div class="form-group mb-4">
                            <label class="form-label fw-bold">Template (Optional)</label>
                            <div class="alert alert-info mb-3">
                                <i class="fas fa-info-circle me-2"></i>
                                Select a template to apply predefined permissions (only applies if Admin/SuperAdmin role is selected).
                            </div>

                            <!-- Template Dropdown -->
                            <div class="mb-3">
                                <select asp-for="TemplateId" asp-items="Model.TemplateList"
                                        class="form-control" id="templateDropdown">
                                    <option value="">-- Select Template --</option>
                                </select>
                            </div>

                            <!-- Template Details Section (Hidden by default) -->
                            <div id="templateSection" style="display: none;">
                                <label class="form-label fw-bold">Template Details</label>
                                <div class="alert alert-info mb-3">
                                    <i class="fas fa-info-circle me-2"></i>
                                    The following permissions will be applied from the selected template.
                                </div>
                                
                                <!-- Template Details Card -->
                                <div id="templateDetails" class="card bg-light mb-3">
                                    <div class="card-body">
                                        <h6 id="templateName" class="card-title"></h6>
                                        <p id="templateDescription" class="card-text"></p>
                                        <div id="templatePermissions" class="mt-2"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Roles Section with Dropdown -->
                        <div class="form-group mb-4">
                            <label class="form-label fw-bold">Assign Roles</label>
                            <div class="alert alert-info mb-3">
                                <i class="fas fa-info-circle me-2"></i>
                                Select roles to assign to this user. Template will only apply if Admin/SuperAdmin role is selected.
                            </div>

                            <!-- Roles Dropdown -->
                            <div class="mb-3">
                                <select id="rolesDropdown" class="form-select" multiple size="5">
                                    @foreach (var role in roles)
                                    {
                                        if (role != null && !string.IsNullOrEmpty(role.Name))
                                        {
                                            <option value="@role.Name">@role.Name</option>
                                        }
                                    }
                                </select>
                                <small class="text-muted">Hold Ctrl/Cmd to select multiple roles</small>
                            </div>

                            <!-- Selected Roles Display -->
                            <div class="mb-3">
                                <label class="form-label fw-bold">Selected Roles:</label>
                                <div id="selectedRolesContainer" class="border rounded p-3"
                                     style="min-height: 60px; background: #f8f9fa;">
                                    <span class="text-muted">No roles selected yet</span>
                                </div>

                                <!-- Hidden input for form submission -->
                                <input type="hidden" id="selectedRolesInput" name="SelectedRoles" value="" />
                            </div>

                            <!-- Quick Role Selection Buttons -->
                            <div class="d-flex flex-wrap gap-2 mb-3">
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllRoles()">
                                    <i class="fas fa-check-square me-1"></i>Select All
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearAllRoles()">
                                    <i class="fas fa-times-circle me-1"></i>Clear All
                                </button>
                                @if (roles.Any(r => r.Name == "Student"))
                                {
                                    <button type="button" class="btn btn-sm btn-outline-success" onclick="selectRole('Student')">
                                        <i class="fas fa-user-graduate me-1"></i>Student
                                    </button>
                                }
                                @if (roles.Any(r => r.Name == "Faculty"))
                                {
                                    <button type="button" class="btn btn-sm btn-outline-info" onclick="selectRole('Faculty')">
                                        <i class="fas fa-chalkboard-teacher me-1"></i>Faculty
                                    </button>
                                }
                                @if (roles.Any(r => r.Name == "Admin"))
                                {
                                    <button type="button" class="btn btn-sm btn-outline-warning" onclick="selectRole('Admin')">
                                        <i class="fas fa-user-shield me-1"></i>Admin
                                    </button>
                                }
                            </div>
                        </div>

                        <!-- Admin Permissions Section (Only shown when Admin role is selected) -->
                        <div class="form-group mb-4" id="adminPermissionsSection" style="display: none;">
                            <label class="form-label fw-bold">Admin Permissions</label>
                            <div class="alert alert-warning mb-3" id="permissionsAlert" style="display: none;">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <span id="alertMessage">Template permissions have been pre-selected. You can customize them below.</span>
                            </div>
                            
                            <!-- Quick Selection Buttons -->
                            <div class="mb-3">
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-outline-primary btn-sm" id="selectAllPermissions">
                                        <i class="fas fa-check-square me-1"></i>Select All
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" id="deselectAllPermissions">
                                        <i class="fas fa-times-circle me-1"></i>Deselect All
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Permission Categories -->
                            <div class="row">
                                @foreach (var group in permissionGroups)
                                {
                                    <div class="col-md-6 mb-4">
                                        <div class="card">
                                            <div class="card-header bg-light">
                                                <h6 class="mb-0">
                                                    <i class="fas @GetGroupIcon(group.GroupName) me-2"></i>
                                                    @group.DisplayName
                                                </h6>
                                            </div>
                                            <div class="card-body">
                                                @foreach (var permission in group.Permissions)
                                                {
                                                    <div class="form-check mb-2">
                                                        <input class="form-check-input permission-checkbox" 
                                                               type="checkbox" 
                                                               name="SelectedPermissions" 
                                                               value="@permission.Permission" 
                                                               id="perm_@permission.Permission">
                                                        <label class="form-check-label" for="perm_@permission.Permission">
                                                            <span class="fw-medium">@permission.DisplayName</span>
                                                            <small class="text-muted d-block">@permission.Description</small>
                                                        </label>
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex justify-content-between mt-4">
                            <a href="@Url.Action("Index", "UserManagement")" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Back to Users
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-user-plus me-2"></i>Create User
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Right Side Info Panel -->
        <div class="col-md-4">
            <div class="card-modern">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Tips</h5>
                </div>
                <div class="card-body">
                    <ul class="mb-0">
                        <li>Use a valid email address for notifications</li>
                        <li>Password must be at least 6 characters</li>
                        <li>Select appropriate roles based on user needs</li>
                        <li>Templates only apply to Admin/SuperAdmin roles</li>
                        <li>Faculty can manage courses and grades</li>
                        <li>Students have limited access</li>
                    </ul>
                </div>
            </div>

            <div class="card-modern mt-3">
                <div class="card-header">
                    <h5 class="mb-0">Available Templates</h5>
                </div>
                <div class="card-body">
                    @if (Model.AvailableTemplates.Any())
                    {
                        <div class="small">
                            @foreach (var template in Model.AvailableTemplates.Take(5))
                            {
                                <div class="mb-2">
                                    <div class="fw-medium">@template.TemplateName</div>
                                    <div class="text-muted">@(template.Description ?? "No description")</div>
                                    <div><small class="badge bg-secondary">@template.AdminType</small></div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <p class="text-muted mb-0">No templates available</p>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@functions {
    // Helper function to get icons for permission groups
    public string GetGroupIcon(string groupName)
    {
        return groupName switch
        {
            "UserManagement" => "fa-users",
            "Student" => "fa-user-graduate",
            "Course" => "fa-book-open",
            "Grade" => "fa-chart-line",
            "Finance" => "fa-money-bill-wave",
            "University" => "fa-university",
            "College" => "fa-building",
            "Department" => "fa-door-open",
            "System" => "fa-cogs",
            "Admin" => "fa-user-shield",
            "Application" => "fa-file-signature",
            _ => "fa-cog"
        };
    }
}

<!-- Hidden element for storing template data -->
<div id="templatesData" 
     data-templates="@Html.Raw(Json.Serialize(Model.AvailableTemplates.Select(t => new {
         Id = t.Id,
         TemplateName = t.TemplateName,
         Description = t.Description ?? "No description",
         AdminType = t.AdminType,
         DefaultPermissions = t.DefaultPermissions != null ? 
             t.DefaultPermissions.Select(p => p.ToString()).ToList() : 
             new List<string>()
     })))"
     style="display:none;"></div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        $(document).ready(function() {
            // Parse templates from data attribute
            const templatesData = $('#templatesData').data('templates');
            const templates = templatesData || [];

            // Initialize selected roles array
            let selectedRoles = [];

            // Check if admin role is selected
            function hasAdminRole() {
                return selectedRoles.some(role => 
                    role === 'Admin' || role === 'SuperAdmin' || 
                    role.includes('Admin') || role === 'UniversityAdmin' || 
                    role === 'FacultyAdmin' || role === 'DepartmentAdmin'
                );
            }

            // Update the hidden input with selected roles
            function updateSelectedRolesInput() {
                $('#selectedRolesInput').val(selectedRoles.join(','));
                updateSelectedRolesDisplay();
                toggleAdminPermissions();
            }

            // Update the display of selected roles
            function updateSelectedRolesDisplay() {
                const container = $('#selectedRolesContainer');
                container.empty();

                if (selectedRoles.length === 0) {
                    container.html('<span class="text-muted">No roles selected yet</span>');
                } else {
                    // Instead of inline onclick, use event delegation
                    selectedRoles.forEach(role => {
                        const badge = $(`
                            <span class="badge
                                ${role === 'SuperAdmin' ? 'bg-danger' :
                                  role === 'Admin' ? 'bg-success' :
                                  role === 'UniversityAdmin' ? 'bg-primary' :
                                  role === 'FacultyAdmin' ? 'bg-info' :
                                  role === 'Student' ? 'bg-warning' :
                                  'bg-secondary'} me-2 mb-2 d-inline-flex align-items-center">
                                ${role}
                                <button type="button" class="btn-close btn-close-white ms-2 remove-role-btn" 
                                        data-role="${role.replace(/"/g, '&quot;')}" style="font-size: 0.5rem;"></button>
                            </span>
                        `);
                        container.append(badge);
                    });

                    // Add event delegation for remove buttons
                    $(document).on('click', '.remove-role-btn', function() {
                        const roleName = $(this).data('role');
                        removeRole(roleName);
                    });
                }
            }

                // Toggle admin permissions section
                function toggleAdminPermissions() {
                    const adminSection = $('#adminPermissionsSection');
                    if (hasAdminRole()) {
                        adminSection.show();
                        $('#templateDropdown').prop('disabled', false);
                    } else {
                        adminSection.hide();
                        $('#templateDropdown').prop('disabled', true).val('');
                        $('#templateSection').hide();
                        $('.permission-checkbox').prop('checked', false);
                    }
                }

                // Add role to selection
                window.addRole = function(roleName) {
                    if (!selectedRoles.includes(roleName)) {
                        selectedRoles.push(roleName);
                        updateSelectedRolesInput();

                        // Select in dropdown
                        $(`#rolesDropdown option[value="${roleName.replace(/"/g, '\\"')}"]`).prop('selected', true);
                    }
                }

            // Remove role from selection
            window.removeRole = function(roleName) {
                selectedRoles = selectedRoles.filter(r => r !== roleName);
                updateSelectedRolesInput();

                // Deselect in dropdown
                $(`#rolesDropdown option[value="${roleName.replace(/"/g, '\\"')}"]`).prop('selected', false);
            }

            // Select specific role
            window.selectRole = function(roleName) {
                addRole(roleName);
            }

            // Select all roles
            window.selectAllRoles = function() {
                $('#rolesDropdown option').each(function() {
                    const roleName = $(this).val();
                    if (!selectedRoles.includes(roleName)) {
                        selectedRoles.push(roleName);
                    }
                    $(this).prop('selected', true);
                });
                updateSelectedRolesInput();
            }

            // Clear all roles
            window.clearAllRoles = function() {
                selectedRoles = [];
                $('#rolesDropdown option').prop('selected', false);
                updateSelectedRolesInput();
            }

            // Handle roles dropdown change
            $('#rolesDropdown').on('change', function() {
                selectedRoles = $(this).val() || [];
                updateSelectedRolesInput();
            });

            // Handle template dropdown change
            $('#templateDropdown').on('change', function() {
                const templateId = $(this).val();
                const template = templates.find(t => t.Id == templateId);
                
                const templateSection = $('#templateSection');
                const templateDetails = $('#templateDetails');
                const permissionsAlert = $('#permissionsAlert');
                const templateName = $('#templateName');
                const templateDescription = $('#templateDescription');
                const permissionsContainer = $('#templatePermissions');
                
                if (template) {
                    // Show template section
                    templateSection.show();
                    templateDetails.show();
                    
                    // Set template details
                    templateName.text(template.TemplateName || '');
                    templateDescription.text(template.Description || '');
                    
                    // Clear previous permission selections
                    $('.permission-checkbox').prop('checked', false);
                    
                    // Display permissions as badges
                    permissionsContainer.empty();
                    
                    if (template.DefaultPermissions && template.DefaultPermissions.length > 0) {
                        const header = $('<div>').addClass('fw-medium mb-2')
                                               .text('Permissions included:');
                        permissionsContainer.append(header);
                        
                        // Create badges and select checkboxes
                        template.DefaultPermissions.forEach(permission => {
                            if (typeof permission === 'string' && permission.trim()) {
                                // Create badge
                                const badge = $('<span>')
                                    .addClass('badge bg-info me-1 mb-1')
                                    .text(permission.replace('_', ' '));
                                permissionsContainer.append(badge);
                                
                                // Select corresponding checkbox
                                const checkbox = $(`input[name="SelectedPermissions"][value="${permission.replace(/"/g, '\\"')}"]`);
                                if (checkbox.length) {
                                    checkbox.prop('checked', true);
                                }
                            }
                        });
                        
                        // Show alert about template permissions
                        permissionsAlert.show();
                        $('#alertMessage').text('Template permissions have been pre-selected. You can customize them below.');
                    } else {
                        permissionsContainer.append(
                            $('<span>').addClass('text-muted').text('No permissions defined')
                        );
                        permissionsAlert.hide();
                    }
                } else {
                    // Hide template section
                    templateSection.hide();
                    permissionsAlert.hide();
                    
                    // Clear all checkboxes
                    $('.permission-checkbox').prop('checked', false);
                }
            });

            // Handle permission checkbox changes
            $('.permission-checkbox').on('change', function() {
                // If user manually changes a checkbox, update the alert
                const permissionsAlert = $('#permissionsAlert');
                if ($('#templateDropdown').val() && permissionsAlert.is(':visible')) {
                    $('#alertMessage').text('Template permissions have been pre-selected. You have customized some permissions.');
                }
            });

            // Select All / Deselect All buttons for permissions
            $('#selectAllPermissions').on('click', function() {
                $('.permission-checkbox').prop('checked', true);
                updatePermissionAlert();
            });
            
            $('#deselectAllPermissions').on('click', function() {
                $('.permission-checkbox').prop('checked', false);
                updatePermissionAlert();
            });
            
            function updatePermissionAlert() {
                const templateSelected = $('#templateDropdown').val();
                if (templateSelected) {
                    $('#permissionsAlert').show();
                    $('#alertMessage').text('You have customized the template permissions.');
                }
            }

            // Initialize with any pre-selected roles
            @if (Model.SelectedRoles != null && Model.SelectedRoles.Any())
            {
                foreach (var role in Model.SelectedRoles)
                {
                    @:addRole('@Html.Raw(role.Replace("'", "\\'"))');
                }
            }

            // Initialize with selected template if any
            @if (Model.TemplateId.HasValue)
            {
                @:if (hasAdminRole()) {
                @:    $('#templateDropdown').trigger('change');
                @:}
            }

            // Form validation
            $('form').on('submit', function(e) {
                // If admin role is selected, check if at least one permission is selected
                if (hasAdminRole()) {
                    const hasPermissions = $('input[name="SelectedPermissions"]:checked').length > 0;
                    
                    if (!hasPermissions) {
                        e.preventDefault();
                        alert('Please select at least one permission for the admin user.');
                        return false;
                    }
                }
            });
        });
    </script>
}